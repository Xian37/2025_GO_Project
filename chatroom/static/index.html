<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GO GO GO Chatroom</title>
<!-- Markdown å’Œç¨‹å¼ç¢¼é«˜äº®æ”¯æ´ -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/atom-one-dark.min.css">
<style>
/* (æ˜Ÿç©ºèƒŒæ™¯ CSS) */
html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: #e0f7fa; }
body { 
  display: flex; justify-content: center; align-items: center; 
  background-color: #0a0a1a;
}
canvas#galaxy { position: fixed; top: 0; left: 0; z-index: -1; }
.container { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border-radius: 12px; padding: 24px; box-shadow: 0 0 20px rgba(255,255,255,0.1); width: 92%; max-width: 1280px; color: #fff; z-index: 1; }
h2, h3 { margin: 8px 0 12px; }
input, button, textarea, label.button { font-size: 1em; padding: 10px 12px; margin: 6px; border-radius: 8px; border: none; background: rgba(255,255,255,0.1); color: #fff; }
button:hover, label.button:hover { background: rgba(255,255,255,0.25); cursor: pointer; }
.modal input[type="text"] { width: 95%; } /* âœ¨ (åŠŸèƒ½ 1) Modal input å¯¬åº¦ */

/* ... (å…¶ä»– CSS èˆ‡ Response 11 ç›¸åŒ) ... */
.row { display: flex; align-items: center; }
.col { display: flex; flex-direction: column; }
#chat-window { display: none; height: 70vh; }
#chat-content { display: flex; height: 100%; }
#sidebar { width: 200px; padding-right: 20px; border-right: 1px solid rgba(255,255,255,0.2); overflow-y: auto; }
#room-list { list-style: none; padding: 0; }
#room-list li { padding: 10px; margin-bottom: 5px; border-radius: 6px; cursor: pointer; }
#room-list li:hover { background: rgba(255,255,255,0.1); }
#room-list li.active { background: rgba(135, 206, 250, 0.4); }
#main-chat { flex-grow: 1; display: flex; flex-direction: column; padding-left: 20px; }
#messages { flex-grow: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
.message { display: flex; margin-bottom: 18px; align-items: flex-start; position: relative; }
.msg-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
.msg-body { max-width: 70%; display: flex; flex-direction: column; position: relative; padding-right: 120px; }
.msg-header { font-size: 0.9em; font-weight: bold; margin-bottom: 4px; opacity: 0.8; }
.msg-content { padding: 10px 14px; background: rgba(0, 0, 0, 0.2); border-radius: 0 12px 12px 12px; line-height: 1.5; word-wrap: break-word; }
.message.system .msg-body { max-width: 100%; align-items: center; }
.message.system .msg-content { background: rgba(135, 206, 250, 0.2); border-radius: 8px; font-style: italic; }
#chat-controls { display: flex; margin-top: 10px; }
#chat-controls input { flex-grow: 1; }
#chat-controls button { background: rgba(135, 206, 250, 0.3); }
#chat-controls button:hover { background: rgba(135, 206, 250, 0.5); }
#login-window { text-align: center; }
#avatar-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin: 20px; justify-items: center; }
.avatar-select { width: 50px; height: 50px; line-height: 50px; font-size: 28px; text-align: center; border-radius: 50%; cursor: pointer; opacity: 0.6; transition: all 0.2s; }
.avatar-select:hover { opacity: 1; transform: scale(1.1); }
.avatar-select.selected { opacity: 1; transform: scale(1.1); box-shadow: 0 0 10px 2px #87CEFA; }
.toolbar { display: flex; flex-wrap: wrap; margin-bottom: 10px; }
.toolbar button, .toolbar label { margin: 4px; padding: 8px 10px; font-size: 0.9em; display: flex; align-items: center; }
#imageInput { display: none; }
#voiceInput { display: none; }
#rec-status { width: 12px; height: 12px; background: #666; border-radius: 50%; margin-left: 8px; }
#rec-status.rec { background: red; animation: pulse 1s infinite; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,0,0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255,0,0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255,0,0, 0); } }
.msg-vote { padding: 10px; border-radius: 8px; background: rgba(0,0,0,0.1); }
.vote-option { display: block; margin: 8px 0; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 6px; cursor: pointer; }
.vote-option:hover { background: rgba(255,255,255,0.2); }
.vote-result { margin-top: 10px; font-size: 0.9em; }
.msg-quiz { padding: 10px; border-radius: 8px; background: rgba(255, 215, 0, 0.1); border: 1px solid rgba(255, 215, 0, 0.5); }
.msg-quiz.answered { background: rgba(0, 255, 0, 0.1); border-color: rgba(0, 255, 0, 0.5); }
.quiz-input { display: flex; margin-top: 8px; }
.quiz-input input { flex-grow: 1; }
.quiz-input button { background: rgba(255, 215, 0, 0.3); }
.reaction-float { position: absolute; font-size: 2em; animation: floatUp 1.4s ease-out; opacity: 0; }
@keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-40px) scale(1.5); opacity: 0; } }
.msg-reactions { margin-top: 5px; }
.msg-reactions button { font-size: 0.8em; padding: 2px 6px; margin: 2px; background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 10px; color: #fff; cursor: pointer; }
.msg-reactions button:hover { background: rgba(255, 255, 255, 0.4); }
.msg-emoji-picker { display: none; position: absolute; top: 4px; right: -110px; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); border-radius: 15px; padding: 2px 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 10; }
.message:hover .msg-emoji-picker { display: block; }
.msg-emoji-picker button { font-size: 1.1em; padding: 0 4px; margin: 0; background: none; border: none; color: #fff; cursor: pointer; transition: transform 0.1s; }
.msg-emoji-picker button:hover { transform: scale(1.3); }
#online-status {
  text-align: center; font-weight: bold; margin: 15px 0 10px 0; padding: 10px;
  background: rgba(0, 255, 127, 0.1); border-radius: 8px;
  border: 1px solid rgba(0, 255, 127, 0.3); font-size: 0.9em;
}
#login-window h2 { font-size: 2.2em; font-weight: 300; letter-spacing: 1px; margin-bottom: 5px; }
#login-window p { font-size: 1.1em; opacity: 0.8; margin-bottom: 20px; }
#avatar-grid { max-width: 400px; margin: 20px auto; }
.avatar-select { width: 60px; height: 60px; line-height: 60px; font-size: 32px; }
#login-window #avatar-preview { width: 80px; height: 80px; margin-bottom: 15px; }
#login-window input[type="text"] { width: 250px; text-align: center; font-size: 1.1em; }
#login-window button { font-size: 1.1em; background: rgba(135, 206, 250, 0.4); font-weight: bold; color: #fff;}
#login-window button:hover { background: rgba(135, 206, 250, 0.6); }
.attachment-preview {
  display: none; align-items: center; margin: 0 10px; 
  background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 8px;
}
.attachment-preview button {
  background:none; border:none; color:red; font-size: 1.5em; 
  padding: 0 5px; cursor: pointer; margin: 0;
}

/* å¼•ç”¨è¨Šæ¯æ¨£å¼ */
.reply-preview {
  display: none;
  background: rgba(135, 206, 250, 0.2);
  border-left: 3px solid #87CEFA;
  padding: 8px 12px;
  margin: 0 10px 10px 10px;
  border-radius: 4px;
  font-size: 0.9em;
  position: relative;
}
.reply-preview .reply-close {
  position: absolute;
  top: 5px;
  right: 5px;
  background: none;
  border: none;
  color: #fff;
  cursor: pointer;
  font-size: 1.2em;
  padding: 0;
  margin: 0;
}
.reply-preview .reply-author {
  font-weight: bold;
  color: #87CEFA;
  margin-bottom: 3px;
}
.reply-preview .reply-content {
  opacity: 0.8;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 400px;
}
.quoted-message {
  background: rgba(135, 206, 250, 0.15);
  border-left: 3px solid #87CEFA;
  padding: 6px 10px;
  margin-bottom: 8px;
  border-radius: 4px;
  font-size: 0.85em;
  opacity: 0.9;
}
.quoted-message .quoted-author {
  font-weight: bold;
  color: #87CEFA;
  margin-bottom: 2px;
}
.quoted-message .quoted-content {
  opacity: 0.8;
}
.msg-reply-btn {
  display: none;
  position: absolute;
  bottom: 4px;
  right: -110px;
  background: rgba(135, 206, 250, 0.3);
  border: 1px solid rgba(135, 206, 250, 0.5);
  color: #fff;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.8em;
  cursor: pointer;
  z-index: 5;
  white-space: nowrap;
}
.message:hover .msg-reply-btn {
  display: block;
}
.msg-reply-btn:hover {
  background: rgba(135, 206, 250, 0.5);
}

/* Markdown æ¨£å¼ */
.msg-content h1, .msg-content h2, .msg-content h3 {
  margin: 8px 0 6px 0;
  line-height: 1.3;
}
.msg-content h1 { font-size: 1.5em; border-bottom: 2px solid rgba(255,255,255,0.2); padding-bottom: 4px; }
.msg-content h2 { font-size: 1.3em; border-bottom: 1px solid rgba(255,255,255,0.15); padding-bottom: 3px; }
.msg-content h3 { font-size: 1.15em; }
.msg-content ul, .msg-content ol {
  margin: 6px 0;
  padding-left: 25px;
}
.msg-content li {
  margin: 3px 0;
}
.msg-content blockquote {
  border-left: 3px solid rgba(255,255,255,0.3);
  margin: 8px 0;
  padding: 6px 12px;
  background: rgba(255,255,255,0.05);
  border-radius: 4px;
}
.msg-content code {
  background: rgba(0,0,0,0.3);
  padding: 2px 6px;
  border-radius: 3px;
  font-family: 'Courier New', monospace;
  font-size: 0.9em;
}
.msg-content pre {
  background: rgba(0,0,0,0.4);
  padding: 12px;
  border-radius: 6px;
  overflow-x: auto;
  margin: 8px 0;
}
.msg-content pre code {
  background: none;
  padding: 0;
}
.msg-content a {
  color: #87CEFA;
  text-decoration: none;
}
.msg-content a:hover {
  text-decoration: underline;
}
.msg-content table {
  border-collapse: collapse;
  margin: 8px 0;
  width: 100%;
}
.msg-content table th,
.msg-content table td {
  border: 1px solid rgba(255,255,255,0.2);
  padding: 6px 10px;
  text-align: left;
}
.msg-content table th {
  background: rgba(255,255,255,0.1);
  font-weight: bold;
}
.msg-content hr {
  border: none;
  border-top: 1px solid rgba(255,255,255,0.2);
  margin: 10px 0;
}

/* âœ¨ (åŠŸèƒ½ 1) Modal CSS */
.modal-backdrop {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(5px);
  z-index: 10;
}
.modal {
  display: none;
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(30, 30, 50, 0.8);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 12px;
  padding: 24px;
  width: 90%;
  max-width: 500px;
  z-index: 11;
}
.modal h4 { margin-top: 0; font-size: 1.4em; }
.modal-close-btn {
  position: absolute;
  top: 10px; right: 15px;
  font-size: 1.5em;
  color: #fff;
  background: none;
  border: none;
  cursor: pointer;
}
.modal label {
  display: block;
  margin-top: 10px;
  margin-bottom: 5px;
  font-weight: bold;
}
/* --- ç¨ç‰¹é¼ æ¨™æ¨£å¼ (æœ€çµ‚ä¿®å¾©ç‰ˆ) --- */

/* 1. è¨­å®šæ•´å€‹ç¶²é çš„ã€Œé»˜èªã€é¼ æ¨™ */
html, body {
  cursor: url("my_cursor.cur"), auto;
}

/* 2. è¨­å®šã€Œå¯é»æ“Šã€å…ƒç´  (æŒ‰éˆ•ç­‰) çš„æ‰‹å‹é¼ æ¨™ */
/*
 * é€™æ˜¯æœ€é‡è¦çš„ä¿®æ”¹ï¼š
 * æˆ‘å€‘åŒæ™‚è¨­å®šäº†å…ƒç´ æœ¬èº« (button) å’Œå®ƒçš„æ‡¸åœç‹€æ…‹ (button:hover)ï¼Œ
 * ä¸¦åŠ ä¸Š !important ä¾†ç¢ºä¿å®ƒçµ•å°å„ªå…ˆã€‚
*/
button,
label.button,
.avatar-select,
#room-list li,
.vote-option,
.msg-emoji-picker button,
.modal-close-btn,
#cancel-image,
#cancel-audio,
input[type="color"],
button:hover,
label.button:hover,
.avatar-select:hover,
#room-list li:hover,
.vote-option:hover,
.msg-emoji-picker button:hover {
  /* * !important æœƒè¦†è“‹æ‰æ‚¨æª”æ¡ˆä¸­ä»»ä½•å…¶ä»–åœ°æ–¹çš„ 'cursor: pointer' è¨­ç½®
   */
  cursor: url("my_pointer.cur"), pointer !important; 
}

/* 3. è¨­å®šæ–‡å­—è¼¸å…¥æ¡†çš„é¼ æ¨™ (ä½¿ç”¨ my_text.cur) */
input[type="text"],
input[type="number"],
textarea {
  cursor: url("my_text.cur"), text;
}
/* --- é¼ æ¨™æ¨£å¼ çµæŸ --- */

/* ç­‰ç´šç³»çµ±æ¨£å¼ */
.level-badge {
  display: inline-block;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.75em;
  font-weight: bold;
  margin-left: 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.title-badge {
  display: inline-block;
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  color: #fff;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.7em;
  margin-left: 4px;
}
.exp-bar {
  width: 100%;
  height: 6px;
  background: rgba(255,255,255,0.1);
  border-radius: 3px;
  overflow: hidden;
  margin-top: 4px;
}
.exp-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  transition: width 0.3s ease;
}
.profile-card {
  background: rgba(30, 30, 50, 0.9);
  border-radius: 12px;
  padding: 20px;
  margin: 10px 0;
  border: 1px solid rgba(255,255,255,0.2);
}
.profile-header {
  display: flex;
  align-items: center;
  margin-bottom: 15px;
}
.profile-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  margin-right: 15px;
  border: 3px solid #667eea;
}
.profile-info {
  flex: 1;
}
.profile-name {
  font-size: 1.5em;
  font-weight: bold;
  margin-bottom: 5px;
}
.profile-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin: 15px 0;
}
.stat-item {
  text-align: center;
  padding: 10px;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
}
.stat-value {
  font-size: 1.5em;
  font-weight: bold;
  color: #87CEFA;
}
.stat-label {
  font-size: 0.85em;
  opacity: 0.7;
  margin-top: 4px;
}
.badges-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
  gap: 10px;
  margin-top: 15px;
}
.badge-item {
  text-align: center;
  padding: 10px;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
}
.badge-item:hover {
  background: rgba(255,255,255,0.1);
  transform: scale(1.05);
}
.badge-item.locked {
  opacity: 0.3;
  cursor: not-allowed;
}
.badge-icon {
  font-size: 2em;
  margin-bottom: 5px;
}
.badge-name {
  font-size: 0.75em;
}
.achievement-list {
  max-height: 300px;
  overflow-y: auto;
}
.achievement-item {
  display: flex;
  align-items: center;
  padding: 12px;
  margin: 8px 0;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  border-left: 4px solid #667eea;
}
.achievement-item.unlocked {
  border-left-color: #4CAF50;
}
.achievement-icon {
  font-size: 2.5em;
  margin-right: 15px;
}
.achievement-info {
  flex: 1;
}
.achievement-name {
  font-weight: bold;
  margin-bottom: 4px;
}
.achievement-desc {
  font-size: 0.85em;
  opacity: 0.7;
}
.achievement-progress {
  width: 100%;
  height: 4px;
  background: rgba(255,255,255,0.1);
  border-radius: 2px;
  margin-top: 6px;
  overflow: hidden;
}
.achievement-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  transition: width 0.3s ease;
}
.level-up-animation {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  padding: 30px 50px;
  border-radius: 15px;
  font-size: 2em;
  font-weight: bold;
  z-index: 1000;
  animation: levelUpBounce 0.6s ease;
  box-shadow: 0 10px 40px rgba(102, 126, 234, 0.6);
}
@keyframes levelUpBounce {
  0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
  50% { transform: translate(-50%, -50%) scale(1.1); }
  100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
}
.user-level-info {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  margin-bottom: 10px;
}
.user-level-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  margin-right: 10px;
}
.user-level-details {
  flex: 1;
}
.user-level-name {
  font-weight: bold;
  margin-bottom: 2px;
}

</style>
</head>
<body>

<canvas id="galaxy"></canvas>

<div class="container" id="login-window">
  <h2>GO GO GO èŠå¤©å®¤</h2>
  <p>è«‹é¸æ“‡ä½ çš„é ­åƒå’Œæš±ç¨±</p>
  <div id="avatar-grid"></div>
  <div style="margin: 10px 0;">
    <img id="avatar-preview" src="" style="width: 80px; height: 80px; border-radius: 50%; display: none; margin: 0 auto 15px; border: 2px solid #87CEFA; object-fit: cover;">
    <label for="avatarUpload" class="button" style="cursor: pointer; padding: 10px 12px; display: inline-block;">
      ğŸ–¼ï¸ ä¸Šå‚³è‡ªè¨‚é ­è²¼
    </label>
    <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
  </div>
  <div class="row" style="justify-content: center;">
    <input type="text" id="nicknameInput" placeholder="è¼¸å…¥æš±ç¨±...">
    <button onclick="login()">ğŸš€ é€²å…¥</button>
  </div>
</div>

<div class="container" id="chat-window">
  <div class="row" style="justify-content: space-between; margin-bottom: 10px;">
    <h3>ğŸ’¬ èŠå¤©å®¤</h3>
    <div>
      <button onclick="goToGame('game.html')">ğŸ® çŒœæ•¸å­—</button>
      <button onclick="goToGame('draw.html')">ğŸ¨ ä½ ç•«æˆ‘çŒœ</button>
    </div>
  </div>
  <div id="chat-content">
    <div id="sidebar">
      <div id="online-status">ğŸŸ¢ åœ¨ç·šï¼š<span id="online-count">0</span> äºº</div>
      
      <!-- ç”¨æˆ¶ç­‰ç´šè³‡è¨Š -->
      <div class="user-level-info">
        <img id="user-avatar-sidebar" class="user-level-avatar" src="" alt="avatar">
        <div class="user-level-details">
          <div class="user-level-name">
            <span id="user-nickname-sidebar"></span>
            <span class="level-badge" id="user-level-badge">Lv.1</span>
            <span class="title-badge" id="user-title-badge" style="display:none;"></span>
          </div>
          <div class="exp-bar">
            <div class="exp-bar-fill" id="user-exp-bar" style="width: 0%;"></div>
          </div>
          <div style="font-size: 0.75em; opacity: 0.7; margin-top: 2px;">
            <span id="user-exp-text">0/100 EXP</span>
          </div>
        </div>
      </div>
      
      <button onclick="showProfileModal()" style="width:100%; margin-bottom:10px;">ğŸ‘¤ å€‹äººè³‡æ–™</button>
      <button onclick="logout()" style="width:100%; margin-bottom:15px;">ç™»å‡º</button>
      <button onclick="showCreateRoomModal()" style="width:100%; margin-bottom:15px;">
        ï¼‹ å»ºç«‹æˆ–åŠ å…¥æˆ¿é–“
      </button>
      <h3>æˆ¿é–“åˆ—è¡¨</h3>
      <ul id="room-list">
        </ul>
      </div>
      <div id="main-chat">
        <h3 id="room-name-header" style="margin: 0 0 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.2);">lobby</h3>
        <ul id="messages"></ul>
        <div class="toolbar">
          <label for="imageInput" class="button" id="image-label">ğŸ–¼ï¸ åœ–ç‰‡</label>
          <input type="file" id="imageInput" accept="image/*">
          <label for="voiceInput" class="button" id="voiceBtn">ğŸ¤ èªéŸ³ (æŒ‰ä½)</label>
          <input type="checkbox" id="voiceInput">
          <span id="rec-status"></span>
          <span id="interim-result" style="margin-left: 10px; font-style: italic; opacity: 0.7;"></span>
          <button onclick="showVoiceSettingsModal()">âš™ï¸ èªéŸ³è¨­å®š</button>
          <button onclick="toggleTTS()" id="tts-toggle">ğŸ”Š æœ—è®€</button>
          <button onclick="showMarkdownHelp()">ğŸ“ Markdown</button>
          <button onclick="showQuizModal()">ğŸ§  å‡ºé¡Œæ¶ç­”</button>
          <button onclick="showVoteModal()">ğŸ“Š ç™¼èµ·æŠ•ç¥¨</button>
        </div>
        <div id="reply-preview" class="reply-preview">
          <button class="reply-close" onclick="cancelReply()">Ã—</button>
          <div class="reply-author"></div>
          <div class="reply-content"></div>
        </div>
        <div class="row" id="chat-controls">
          <input type="text" id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯...">
          <div id="image-preview-container" class="attachment-preview">
            <img id="image-preview" src="" style="max-height: 40px; border-radius: 4px;">
            <button id="cancel-image">&times;</button>
          </div>
          <div id="audio-preview-container" class="attachment-preview">
            <span>ğŸ¤ èªéŸ³å·²é™„åŠ </span>
            <button id="cancel-audio">&times;</button>
          </div>
          <button onclick="sendMsg()">ğŸš€ é€å‡º</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="modal-backdrop" onclick="closeModals()"></div>

<div id="quiz-modal" class="modal">
  <button class="modal-close-btn" onclick="closeModals()">&times;</button>
  <h4>ğŸ§  å»ºç«‹æ¶ç­”</h4>
  <label for="quiz-question">é¡Œç›®ï¼š</label>
  <input type="text" id="quiz-question" placeholder="ä¾‹å¦‚ï¼šä»€éº¼æ˜¯ä¸–ç•Œä¸Šæœ€å¿«çš„å‹•ç‰©ï¼Ÿ">
  <label for="quiz-answer">ç­”æ¡ˆï¼š</label>
  <input type="text" id="quiz-answer" placeholder="ä¾‹å¦‚ï¼šçµè±¹">
  <button onclick="submitQuiz()" style="margin-top: 15px; width: 100%;">ç™¼é€æ¶ç­”</button>
</div>

<div id="vote-modal" class="modal">
  <button class="modal-close-btn" onclick="closeModals()">&times;</button>
  <h4>ğŸ“Š å»ºç«‹æŠ•ç¥¨</h4>
  <label for="vote-question">å•é¡Œï¼š</label>
  <input type="text" id="vote-question" placeholder="ä¾‹å¦‚ï¼šæ™šé¤è¦åƒä»€éº¼ï¼Ÿ">
  <label for="vote-options">é¸é … (ç”¨é€—è™Ÿ , åˆ†éš”)ï¼š</label>
  <input type="text" id="vote-options" placeholder="ä¾‹å¦‚ï¼šæŠ«è–©, æ¼¢å ¡, ç¾©å¤§åˆ©éºµ">
  <button onclick="submitVote()" style="margin-top: 15px; width: 100%;">ç™¼é€æŠ•ç¥¨</button>
</div>

<div id="create-room-modal" class="modal">
  <button class="modal-close-btn" onclick="closeModals()">&times;</button>
  <h4>+ å»ºç«‹æˆ–åŠ å…¥æˆ¿é–“</h4>
  <label for="modal-room-name">æˆ¿é–“åç¨±ï¼š</label>
  <input type="text" id="modal-room-name" placeholder="è¼¸å…¥æˆ¿é–“åç¨±...">
  <label for="modal-room-pass">å¯†ç¢¼ (å¯é¸)ï¼š</label>
  <input type="password" id="modal-room-pass" placeholder="ç‚ºæ‚¨çš„æˆ¿é–“è¨­å®šå¯†ç¢¼...">
  <button onclick="submitCreateRoom()" style="margin-top: 15px; width: 100%;">ç¢ºèª</button>
</div>

<div id="voice-settings-modal" class="modal">
  <button class="modal-close-btn" onclick="closeModals()">&times;</button>
  <h4>âš™ï¸ èªéŸ³è¨­å®š</h4>
  
  <label for="voice-lang">è¾¨è­˜èªè¨€ï¼š</label>
  <select id="voice-lang" style="width: 100%; padding: 10px; margin: 6px; border-radius: 8px; background: #1a1a2e; color: #fff; border: 1px solid rgba(255,255,255,0.3);">
    <option value="cmn-Hant-TW" style="background: #1a1a2e; color: #fff;">ç¹é«”ä¸­æ–‡ (å°ç£)</option>
    <option value="zh-CN" style="background: #1a1a2e; color: #fff;">ç°¡é«”ä¸­æ–‡</option>
    <option value="en-US" style="background: #1a1a2e; color: #fff;">English (US)</option>
    <option value="en-GB" style="background: #1a1a2e; color: #fff;">English (UK)</option>
    <option value="ja-JP" style="background: #1a1a2e; color: #fff;">æ—¥æœ¬èª</option>
    <option value="ko-KR" style="background: #1a1a2e; color: #fff;">í•œêµ­ì–´</option>
    <option value="es-ES" style="background: #1a1a2e; color: #fff;">EspaÃ±ol</option>
    <option value="fr-FR" style="background: #1a1a2e; color: #fff;">FranÃ§ais</option>
    <option value="de-DE" style="background: #1a1a2e; color: #fff;">Deutsch</option>
  </select>
  
  <label style="margin-top: 15px;">
    <input type="checkbox" id="voice-continuous" style="width: auto; margin-right: 8px;">
    é€£çºŒè¾¨è­˜æ¨¡å¼
  </label>
  
  <label style="margin-top: 10px;">
    <input type="checkbox" id="voice-interim" checked style="width: auto; margin-right: 8px;">
    é¡¯ç¤ºå³æ™‚è¾¨è­˜çµæœ
  </label>
  
  <label style="margin-top: 10px;">
    <input type="checkbox" id="voice-commands" checked style="width: auto; margin-right: 8px;">
    å•Ÿç”¨èªéŸ³å‘½ä»¤
  </label>
  
  <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
    <strong>å¯ç”¨èªéŸ³å‘½ä»¤ï¼š</strong><br>
    <small style="opacity: 0.8;">
      â€¢ ã€Œç™¼é€ã€æˆ–ã€Œé€å‡ºã€- ç™¼é€è¨Šæ¯<br>
      â€¢ ã€Œæ¸…é™¤ã€- æ¸…é™¤è¼¸å…¥<br>
      â€¢ ã€Œæ¶ç­”ã€- é–‹å•Ÿæ¶ç­”<br>
      â€¢ ã€ŒæŠ•ç¥¨ã€- é–‹å•ŸæŠ•ç¥¨<br>
      â€¢ ã€Œæœ—è®€ã€- åˆ‡æ›æœ—è®€åŠŸèƒ½
    </small>
  </div>
  
  <label for="tts-voice" style="margin-top: 15px;">æœ—è®€èªéŸ³ï¼š</label>
  <select id="tts-voice" style="width: 100%; padding: 10px; margin: 6px; border-radius: 8px; background: #1a1a2e; color: #fff; border: 1px solid rgba(255,255,255,0.3);">
  </select>
  
  <label for="tts-rate" style="margin-top: 15px;">æœ—è®€é€Ÿåº¦ï¼š<span id="rate-value">1.0</span></label>
  <input type="range" id="tts-rate" min="0.5" max="2" step="0.1" value="1" style="width: 100%;">
  
  <label for="tts-pitch" style="margin-top: 10px;">æœ—è®€éŸ³èª¿ï¼š<span id="pitch-value">1.0</span></label>
  <input type="range" id="tts-pitch" min="0.5" max="2" step="0.1" value="1" style="width: 100%;">
  
  <button onclick="testTTS()" style="margin-top: 15px; width: 100%;">ğŸ”Š æ¸¬è©¦æœ—è®€</button>
  <button onclick="saveVoiceSettings()" style="margin-top: 10px; width: 100%; background: rgba(135, 206, 250, 0.4);">ğŸ’¾ å„²å­˜è¨­å®š</button>
</div>

<div id="markdown-help-modal" class="modal">
  <button class="modal-close-btn" onclick="closeModals()">Ã—</button>
  <h4>ğŸ“ Markdown èªæ³•èªªæ˜</h4>
  <div style="max-height: 400px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
    <p><strong># æ¨™é¡Œ</strong> â†’ å¤§æ¨™é¡Œ</p>
    <p><strong>## æ¬¡æ¨™é¡Œ</strong> â†’ æ¬¡æ¨™é¡Œ</p>
    <p><strong>**ç²—é«”**</strong> â†’ <strong>ç²—é«”</strong></p>
    <p><strong>*æ–œé«”*</strong> â†’ <em>æ–œé«”</em></p>
    <p><strong>~~åˆªé™¤ç·š~~</strong> â†’ <del>åˆªé™¤ç·š</del></p>
    <p><strong>- é …ç›®</strong> â†’ ç„¡åºåˆ—è¡¨</p>
    <p><strong>1. é …ç›®</strong> â†’ æœ‰åºåˆ—è¡¨</p>
    <p><strong>[é€£çµ](ç¶²å€)</strong> â†’ è¶…é€£çµ</p>
    <p><strong>> å¼•ç”¨</strong> â†’ å¼•ç”¨æ–‡å­—</p>
    <p><strong>`ç¨‹å¼ç¢¼`</strong> â†’ è¡Œå…§ç¨‹å¼ç¢¼</p>
    <p><strong>```ç¨‹å¼ç¢¼å€å¡Š```</strong> â†’ ç¨‹å¼ç¢¼å€å¡Š</p>
    <hr style="margin: 15px 0;">
    <p style="font-size: 0.9em; opacity: 0.8;">ğŸ’¡ æç¤ºï¼šè¨Šæ¯æœƒè‡ªå‹•æ¸²æŸ“ Markdown æ ¼å¼</p>
  </div>
  <button onclick="closeModals()" style="margin-top: 15px; width: 100%; background: rgba(135, 206, 250, 0.4);">âœ“ çŸ¥é“äº†</button>
</div>

<div id="profile-modal" class="modal" style="max-width: 600px;">
  <button class="modal-close-btn" onclick="closeModals()">Ã—</button>
  <h4>ğŸ‘¤ å€‹äººè³‡æ–™</h4>
  
  <div class="profile-card">
    <div class="profile-header">
      <img id="profile-avatar" class="profile-avatar" src="" alt="avatar">
      <div class="profile-info">
        <div class="profile-name">
          <span id="profile-nickname"></span>
          <span class="level-badge" id="profile-level-badge">Lv.1</span>
        </div>
        <div id="profile-title" class="title-badge" style="display:inline-block;"></div>
        <div class="exp-bar" style="margin-top: 8px;">
          <div class="exp-bar-fill" id="profile-exp-bar" style="width: 0%;"></div>
        </div>
        <div style="font-size: 0.85em; opacity: 0.7; margin-top: 4px;">
          <span id="profile-exp-text">0/100 EXP</span>
        </div>
      </div>
    </div>
    
    <div class="profile-stats">
      <div class="stat-item">
        <div class="stat-value" id="stat-level">1</div>
        <div class="stat-label">ç­‰ç´š</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-messages">0</div>
        <div class="stat-label">è¨Šæ¯æ•¸</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="stat-badges">0</div>
        <div class="stat-label">å¾½ç« </div>
      </div>
    </div>
  </div>
  
  <h4 style="margin-top: 20px;">ğŸ† æˆå°±ç³»çµ±</h4>
  <div class="achievement-list" id="achievement-list">
    <!-- æˆå°±é …ç›®æœƒå‹•æ…‹ç”Ÿæˆ -->
  </div>
  
  <h4 style="margin-top: 20px;">ğŸ–ï¸ æˆ‘çš„å¾½ç« </h4>
  <div class="badges-grid" id="badges-grid">
    <!-- å¾½ç« æœƒå‹•æ…‹ç”Ÿæˆ -->
  </div>
</div>

<script>
// (æ˜Ÿç©º JS èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
const canvas = document.getElementById('galaxy');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
let stars = [];
for (let i = 0; i < 800; i++) {
  stars.push({ x: Math.random(), y: Math.random(), z: Math.random() });
}
function drawGalaxy() {
  ctx.fillStyle = '#0a0a1a';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.save();
  ctx.translate(canvas.width / 2, canvas.height / 2);
  let time = Date.now() * 0.0001;
  stars.forEach(star => {
    let x = (star.x - 0.5) * canvas.width * (2 - star.z) + Math.sin(time + star.z) * 100 * star.z;
    let y = (star.y - 0.5) * canvas.height * (2 - star.z) + Math.cos(time + star.x) * 100 * star.z;
    let r = (1 - star.z) * 1.5;
    let a = (1 - star.z);
    ctx.fillStyle = `rgba(255, 255, 255, ${a})`;
    ctx.beginPath(); ctx.arc(x, y, r, 0, 2 * Math.PI); ctx.fill();
  });
  ctx.restore();
  requestAnimationFrame(drawGalaxy);
}
drawGalaxy();
window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };

// (è¼”åŠ©å‡½å¼èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
function resizeImage(base64Str, maxSize = 96, callback) {
  const img = new Image();
  img.src = base64Str;
  img.onload = () => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = maxSize;
    canvas.height = maxSize;
    let sourceSize = Math.min(img.width, img.height);
    let sourceX = (img.width - sourceSize) / 2;
    let sourceY = (img.height - sourceSize) / 2;
    ctx.drawImage(img, sourceX, sourceY, sourceSize, sourceSize, 0, 0, maxSize, maxSize);
    callback(canvas.toDataURL('image/png'));
  };
}

// (DOM å…ƒç´ èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
const loginWindow = document.getElementById('login-window');
const chatWindow = document.getElementById('chat-window');
const nicknameInput = document.getElementById('nicknameInput');
const avatarGrid = document.getElementById('avatar-grid');
const messagesEl = document.getElementById('messages');
const messageInput = document.getElementById('messageInput');
const roomListEl = document.getElementById('room-list');
const newRoomInput = document.getElementById('newRoomInput');
const newRoomPassword = document.getElementById('newRoomPassword');
const imageInput = document.getElementById('imageInput');
const voiceInput = document.getElementById('voiceInput');
const voiceBtn = document.getElementById('voiceBtn');
const recStatus = document.getElementById('rec-status');

// âœ¨ (åŠŸèƒ½ 1) Modal DOM
const modalBackdrop = document.getElementById('modal-backdrop');
const quizModal = document.getElementById('quiz-modal');
const voteModal = document.getElementById('vote-modal');
const createRoomModal = document.getElementById('create-room-modal');

// (ç‹€æ…‹è®Šæ•¸èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
let ws;
let myNickname = '';
let myAvatar = '';
let currentRoom = localStorage.getItem('lastRoom') || 'lobby';
if (localStorage.getItem('lastRoom')) {
  localStorage.removeItem('lastRoom');
}
let roomInfo = {};
let quizAnswer = ''; 
let mediaRecorder;
let audioChunks = [];
let imageToSend = null;
let audioToSend = null; 
let audioTranscript = null;

// å¼•ç”¨è¨Šæ¯è®Šæ•¸
let replyToMessage = null;

// ç­‰ç´šç³»çµ±è®Šæ•¸
let userLevel = parseInt(localStorage.getItem('userLevel')) || 1;
let userExp = parseInt(localStorage.getItem('userExp')) || 0;
let userTitle = localStorage.getItem('userTitle') || '';
let totalMessages = parseInt(localStorage.getItem('totalMessages')) || 0;
let unlockedBadges = JSON.parse(localStorage.getItem('unlockedBadges') || '[]');

// ç­‰ç´šç¶“é©—å€¼è¡¨ï¼ˆæ¯ç´šæ‰€éœ€ç¶“é©—ï¼‰
const expTable = [
  100, 200, 350, 550, 800, 1100, 1450, 1850, 2300, 2800, // Lv 1-10
  3350, 3950, 4600, 5300, 6050, 6850, 7700, 8600, 9550, 10550, // Lv 11-20
  11600, 12700, 13850, 15050, 16300, 17600, 18950, 20350, 21800, 23300 // Lv 21-30
];

// ç¨±è™Ÿç³»çµ±
const titles = {
  newbie: { name: 'æ–°æ‰‹', condition: () => userLevel >= 1 },
  active: { name: 'æ´»èºè€…', condition: () => totalMessages >= 50 },
  veteran: { name: 'è€æ‰‹', condition: () => totalMessages >= 200 },
  master: { name: 'å¤§å¸«', condition: () => userLevel >= 10 },
  legend: { name: 'å‚³å¥‡', condition: () => userLevel >= 20 },
  champion: { name: 'å† è»', condition: () => totalMessages >= 500 }
};

// æˆå°±ç³»çµ±
const achievements = [
  { id: 'first_msg', name: 'åˆæ¬¡ç™¼è¨€', desc: 'ç™¼é€ç¬¬ä¸€æ¢è¨Šæ¯', icon: 'ğŸ’¬', target: 1, progress: 0 },
  { id: 'chat_10', name: 'å¥è«‡', desc: 'ç™¼é€10æ¢è¨Šæ¯', icon: 'ğŸ—£ï¸', target: 10, progress: 0 },
  { id: 'chat_50', name: 'è©±ç™†', desc: 'ç™¼é€50æ¢è¨Šæ¯', icon: 'ğŸ’­', target: 50, progress: 0 },
  { id: 'chat_100', name: 'èŠå¤©å¤§å¸«', desc: 'ç™¼é€100æ¢è¨Šæ¯', icon: 'ğŸ¤', target: 100, progress: 0 },
  { id: 'level_5', name: 'å°æœ‰åæ°£', desc: 'é”åˆ°5ç´š', icon: 'â­', target: 5, progress: 0 },
  { id: 'level_10', name: 'çŸ¥åäººå£«', desc: 'é”åˆ°10ç´š', icon: 'ğŸŒŸ', target: 10, progress: 0 },
  { id: 'level_20', name: 'å‚³å¥‡äººç‰©', desc: 'é”åˆ°20ç´š', icon: 'âœ¨', target: 20, progress: 0 },
  { id: 'vote_create', name: 'æ°‘ä¸»å…ˆé‹’', desc: 'ç™¼èµ·ä¸€æ¬¡æŠ•ç¥¨', icon: 'ğŸ—³ï¸', target: 1, progress: 0 },
  { id: 'quiz_create', name: 'å‡ºé¡Œè€…', desc: 'ç™¼èµ·ä¸€æ¬¡æ¶ç­”', icon: 'ğŸ§ ', target: 1, progress: 0 },
  { id: 'reaction_send', name: 'åæ‡‰éˆæ•', desc: 'ç™¼é€10å€‹è¡¨æƒ…å›æ‡‰', icon: 'ğŸ˜Š', target: 10, progress: 0 },
  { id: 'voice_use', name: 'èªéŸ³é”äºº', desc: 'ä½¿ç”¨5æ¬¡èªéŸ³è¨Šæ¯', icon: 'ğŸ™ï¸', target: 5, progress: 0 },
  { id: 'image_send', name: 'æ”å½±å¸«', desc: 'ç™¼é€10å¼µåœ–ç‰‡', icon: 'ğŸ“·', target: 10, progress: 0 }
];

// å¾ localStorage è¼‰å…¥æˆå°±é€²åº¦
achievements.forEach(ach => {
  ach.progress = parseInt(localStorage.getItem(`ach_${ach.id}`) || '0');
});

// èªéŸ³è¨­å®šè®Šæ•¸
let voiceLang = localStorage.getItem('voiceLang') || 'cmn-Hant-TW';
let voiceContinuous = localStorage.getItem('voiceContinuous') === 'true';
let voiceInterim = localStorage.getItem('voiceInterim') !== 'false'; // é è¨­é–‹å•Ÿ
let voiceCommands = localStorage.getItem('voiceCommands') !== 'false'; // é è¨­é–‹å•Ÿ
let ttsEnabled = localStorage.getItem('ttsEnabled') === 'true';
let ttsRate = parseFloat(localStorage.getItem('ttsRate')) || 1.0;
let ttsPitch = parseFloat(localStorage.getItem('ttsPitch')) || 1.0;
let ttsVoiceName = localStorage.getItem('ttsVoiceName') || '';
let speechSynthesis = window.speechSynthesis;
let availableVoices = [];

function goToGame(url) {
  localStorage.setItem('lastRoom', currentRoom);
  location.href = url;
}

function logout() {
  localStorage.removeItem("chatUser");
  localStorage.removeItem("chatAvatar");
  localStorage.removeItem("lastRoom");
  if (ws) {
    ws.onclose = () => {}; // Prevent the default disconnect message
    ws.close();
  }
  location.reload();
}

// (é ­åƒé‚è¼¯èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
const avatars = ['ğŸ˜€','ğŸ˜','ğŸš€','ğŸ¤–','ğŸ§ ','ğŸ¨','ğŸ®','ğŸ†','ğŸ’¡','ğŸ“Š'];
avatars.forEach(a => {
  const av = document.createElement('span');
  av.className = 'avatar-select';
  av.textContent = a;
  av.onclick = () => {
    myAvatar = a;
    document.querySelectorAll('.avatar-select').forEach(el => el.classList.remove('selected'));
    av.classList.add('selected');
    avatarPreview.style.display = 'none';
    avatarPreview.src = '';
  };
  avatarGrid.appendChild(av);
});
const avatarUpload = document.getElementById('avatarUpload');
const avatarPreview = document.getElementById('avatar-preview');
avatarUpload.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = re => {
    const fullSizeBase64 = re.target.result;
    resizeImage(fullSizeBase64, 96, (resizedBase64) => {
      myAvatar = resizedBase64;
      avatarPreview.src = myAvatar;
      avatarPreview.style.display = 'block';
      document.querySelectorAll('.avatar-select').forEach(el => el.classList.remove('selected'));
    });
  };
  reader.readAsDataURL(file);
});

// (login å‡½å¼èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
function login() {
  myNickname = nicknameInput.value.trim();
  if (myNickname && myAvatar) {
    localStorage.setItem("chatUser", myNickname);
    localStorage.setItem("chatAvatar", myAvatar);
    loginWindow.style.display = 'none';
    chatWindow.style.display = 'block';
    
    // åˆå§‹åŒ–ç”¨æˆ¶ç­‰ç´š UI
    updateUserLevelUI();
    
    // æ›´æ–°å´é‚Šæ¬„é ­åƒå’Œæš±ç¨±
    const userAvatarSidebar = document.getElementById('user-avatar-sidebar');
    if (myAvatar.startsWith('http') || myAvatar.startsWith('data:')) {
      userAvatarSidebar.src = myAvatar;
    } else {
      const canvas = document.createElement('canvas');
      canvas.width = 40; canvas.height = 40;
      const ctx = canvas.getContext('2d');
      ctx.font = '30px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(myAvatar, 20, 23);
      userAvatarSidebar.src = canvas.toDataURL();
    }
    document.getElementById('user-nickname-sidebar').textContent = myNickname;
    
    initWS();
  } else {
    alert('è«‹è¼¸å…¥æš±ç¨±ä¸¦é¸æ“‡é ­åƒï¼');
  }
}

// âœ¨ (BUG 1) ç§»é™¤éŒ¯èª¤çš„ JS
// (initWS, handleIncoming, sendMsg ç­‰å‡½å¼èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
let reconnectInterval = 1000; // åˆå§‹é‡é€£é–“éš” 1 ç§’
let maxReconnectInterval = 30000; // æœ€å¤§é‡é€£é–“éš” 30 ç§’

function initWS() {
  const proto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${window.location.host}/ws`);
  
  ws.onopen = () => {
    console.log('Connected to WS');
    reconnectInterval = 1000; // é€£ç·šæˆåŠŸï¼Œé‡ç½®é‡é€£é–“éš”
    document.getElementById('online-status').style.display = 'block'; // é¡¯ç¤ºåœ¨ç·šç‹€æ…‹
    addSystemMessage('å·²é€£ç·šåˆ°èŠå¤©å®¤ï¼');
    switchRoom(currentRoom, true);
  };
  
  ws.onmessage = event => {
    const msg = JSON.parse(event.data);
    console.log('[DEBUG] Received message:', msg);
    handleIncoming(msg);
  };
  
  ws.onclose = () => {
    console.log('Disconnected from WS');
    document.getElementById('online-count').textContent = '0'; // æ–·ç·šæ™‚äººæ•¸æ­¸é›¶
    
    // å˜—è©¦è‡ªå‹•é‡é€£
    console.log(`Attempting to reconnect in ${reconnectInterval/1000} seconds...`);
    setTimeout(initWS, reconnectInterval);
    
    // æŒ‡æ•¸é€€é¿ï¼šæ¯æ¬¡å¤±æ•—ç­‰å¾…æ™‚é–“åŠ å€ï¼Œç›´åˆ°æœ€å¤§å€¼
    reconnectInterval = Math.min(reconnectInterval * 2, maxReconnectInterval);
  };
  
  ws.onerror = err => {
    console.error('WS Error:', err);
    ws.close(); // éŒ¯èª¤æ™‚ä¸»å‹•é—œé–‰ä»¥è§¸ç™¼é‡é€£
  };
}

function handleIncoming(msg) {
  console.log('[DEBUG] Handling message type:', msg.type);
  switch (msg.type) {
    case 'online_count':
      document.getElementById('online-count').textContent = msg.content;
      break;
    case 'room_list':
      updateRoomList(msg.roomInfo);
      break;
    case 'password_required':
      const pw = prompt(`æˆ¿é–“ ${msg.room} éœ€è¦å¯†ç¢¼ï¼š`);
      if (pw) {
        switchRoom(msg.room, false, pw);
      }
      break;
    case 'wrong_password':
      alert(`æˆ¿é–“ ${msg.room} çš„å¯†ç¢¼éŒ¯èª¤ï¼`);
      break;
    case 'switch_success':
      currentRoom = msg.room;
      document.getElementById('room-name-header').textContent = currentRoom;
      messagesEl.innerHTML = ''; // Clear messages from old room
      addSystemMessage(`æˆåŠŸåŠ å…¥æˆ¿é–“: ${currentRoom}`);
      document.querySelectorAll('#room-list li').forEach(li => {
        li.classList.toggle('active', li.dataset.room === currentRoom);
      });
      break;
    case 'chat': case 'image': case 'voice':
      renderMessage(msg); break;
    case 'join': case 'leave': case 'switch':
      addSystemMessage(msg.content); break;
    case 'vote':
      renderVote(msg); break;
    case 'vote_result':
      updateVoteResults(msg); break;
    case 'quiz_start':
      quizAnswer = msg.answer; renderQuiz(msg); break;
    case 'quiz_answer':
      break;
    case 'quiz_result':
      quizAnswer = ''; updateQuizResult(msg); break;
    case 'reaction': {
      const floatTarget = Array.from(messagesEl.children).find(li => li.dataset.id === msg.content);
      if (floatTarget) {
        const flo = document.createElement('div'); flo.className = 'reaction-float'; flo.textContent = msg.emoji;
        flo.style.left = '60px'; flo.style.top = '10px';
        floatTarget.appendChild(flo); setTimeout(() => flo.remove(), 1400);
      }
      if (!floatTarget) return; 
      const reactionsEl = floatTarget.querySelector('.msg-reactions');
      if (!reactionsEl) return; 
      let countBtn = reactionsEl.querySelector(`[data-emoji="${msg.emoji}"]`);
      if (!countBtn) {
        countBtn = document.createElement('button');
        countBtn.dataset.emoji = msg.emoji;
        countBtn.dataset.count = 1;
        countBtn.textContent = `${msg.emoji} 1`;
        countBtn.onclick = () => { sendReaction(msg.content, msg.emoji); };
        reactionsEl.appendChild(countBtn);
      } else {
        const newCount = parseInt(countBtn.dataset.count) + 1;
        countBtn.dataset.count = newCount;
        countBtn.textContent = `${msg.emoji} ${newCount}`;
      }
      break;
    }
  }
}

function sendMsg() {
  if (!ws || ws.readyState !== WebSocket.OPEN) {
    alert('é€£ç·šå°šæœªå»ºç«‹ï¼Œè«‹ç¨å¾Œå†è©¦ï¼');
    return;
  }
  
  const content = messageInput.value.trim();
  if (imageToSend) {
    const msgData = {
      type: 'image', room: currentRoom, nickname: myNickname, avatar: myAvatar,
      content: imageToSend, timestamp: new Date().toISOString(),
      level: userLevel, title: userTitle
    };
    if (replyToMessage) msgData.replyTo = replyToMessage;
    ws.send(JSON.stringify(msgData));
    document.getElementById('cancel-image').onclick();
    cancelReply();
    onMessageSent('image');
  } else if (audioToSend) {
    const msgData = {
      type: 'voice', room: currentRoom, nickname: myNickname, avatar: myAvatar,
      content: audioToSend, transcript: content, timestamp: new Date().toISOString(),
      level: userLevel, title: userTitle
    };
    if (replyToMessage) msgData.replyTo = replyToMessage;
    ws.send(JSON.stringify(msgData));
    document.getElementById('cancel-audio').onclick();
    cancelReply();
    onMessageSent('voice');
  } else if (content) {
    const msgData = {
      type: 'chat', room: currentRoom, nickname: myNickname, avatar: myAvatar,
      content: content, timestamp: new Date().toISOString(),
      level: userLevel, title: userTitle
    };
    if (replyToMessage) msgData.replyTo = replyToMessage;
    console.log('[DEBUG] Sending message:', msgData);
    ws.send(JSON.stringify(msgData));
    messageInput.value = '';
    cancelReply();
    onMessageSent('chat');
  }
}
messageInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
});
imageInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 5 * 1024 * 1024) { alert('åœ–ç‰‡å¤ªå¤§ï¼è«‹ä¸Šå‚³ 5MB ä»¥ä¸‹çš„åœ–ç‰‡ã€‚'); return; }
  const reader = new FileReader();
  reader.onload = re => {
    imageToSend = re.target.result; 
    document.getElementById('image-preview').src = imageToSend;
    document.getElementById('image-preview-container').style.display = 'flex';
    messageInput.disabled = true; 
    messageInput.placeholder = 'å·²é™„åŠ åœ–ç‰‡';
    voiceBtn.style.display = 'none';
  };
  reader.readAsDataURL(file);
  imageInput.value = null; 
});
document.getElementById('cancel-image').onclick = () => {
  imageToSend = null;
  document.getElementById('image-preview').src = '';
  document.getElementById('image-preview-container').style.display = 'none';
  messageInput.disabled = false;
  messageInput.placeholder = 'è¼¸å…¥è¨Šæ¯...';
  voiceBtn.style.display = 'flex';
};
document.getElementById('cancel-audio').onclick = () => {
  audioToSend = null;
  audioTranscript = null;
  document.getElementById('audio-preview-container').style.display = 'none';
  messageInput.value = '';
  messageInput.placeholder = 'è¼¸å…¥è¨Šæ¯...';
  document.getElementById('image-label').style.display = 'flex';
};
function switchRoom(room, firstTime = false, password = '') {
  if (room === currentRoom && !firstTime) return;
  
  // Don't set currentRoom here, wait for server confirmation
  ws.send(JSON.stringify({
    type: 'switch', room: room, nickname: myNickname,
    avatar: myAvatar, timestamp: new Date().toISOString(),
    password: password
  }));
}

function showCreateRoomModal() {
  modalBackdrop.style.display = 'block';
  createRoomModal.style.display = 'block';
  document.getElementById('modal-room-name').focus();
}

function closeModals() {
  modalBackdrop.style.display = 'none';
  quizModal.style.display = 'none';
  voteModal.style.display = 'none';
  createRoomModal.style.display = 'none';
  const voiceSettingsModal = document.getElementById('voice-settings-modal');
  if (voiceSettingsModal) voiceSettingsModal.style.display = 'none';
  const markdownHelpModal = document.getElementById('markdown-help-modal');
  if (markdownHelpModal) markdownHelpModal.style.display = 'none';
  const profileModal = document.getElementById('profile-modal');
  if (profileModal) profileModal.style.display = 'none';
}

function submitCreateRoom() {
  const roomName = document.getElementById('modal-room-name').value.trim().toLowerCase().replace(/ /g, '-');
  const password = document.getElementById('modal-room-pass').value.trim();
  if (roomName) { 
    switchRoom(roomName, false, password); 
    closeModals();
    document.getElementById('modal-room-name').value = '';
    document.getElementById('modal-room-pass').value = '';
  } else {
    alert("è«‹è¼¸å…¥æˆ¿é–“åç¨±ï¼");
  }
}

function joinRoom(room) {
  if (room === currentRoom && room !== 'lobby') return;

  if (roomInfo.hasOwnProperty(room)) {
    if (roomInfo[room]) { 
      const pw = prompt(`æˆ¿é–“ ${room} éœ€è¦å¯†ç¢¼ï¼š`);
      if (pw !== null) {
        switchRoom(room, false, pw);
      }
    } else {
      switchRoom(room, false, ''); 
    }
  } else {
    alert(`æˆ¿é–“ ${room} å·²ä¸å­˜åœ¨ï¼Œé é¢å°‡æœƒé‡æ–°æ•´ç†ã€‚`);
    location.reload();
  }
}

function updateRoomList(rooms) {
  roomInfo = rooms;
  roomListEl.innerHTML = '';
 
  if (roomInfo['lobby'] !== undefined) {
      const lobbyLi = document.createElement('li');
      lobbyLi.dataset.room = 'lobby';
      lobbyLi.textContent = 'lobby';
      lobbyLi.className = ('lobby' === currentRoom) ? 'active' : '';
      lobbyLi.onclick = () => joinRoom('lobby');
      roomListEl.appendChild(lobbyLi);
  }

  const roomNames = Object.keys(rooms);
  const sortedRooms = roomNames.filter(room => room !== 'lobby').sort();

  sortedRooms.forEach(room => {
    const isPrivate = rooms[room];
    const li = document.createElement('li');
    li.dataset.room = room;
    li.textContent = room + (isPrivate ? ' ğŸ”’' : '');
    li.className = (room === currentRoom) ? 'active' : '';
    li.onclick = () => joinRoom(room);
    roomListEl.appendChild(li);
  });
}

function renderMessage(msg) {
  const li = document.createElement('li');
  li.className = 'message';
  li.dataset.id = msg.timestamp;
  li.dataset.nickname = msg.nickname;
  li.dataset.content = msg.content || '';
  
  const avatar = document.createElement('img');
  avatar.className = 'msg-avatar';
  if (msg.avatar.startsWith('http') || msg.avatar.startsWith('data:')) {
    avatar.src = msg.avatar;
  } else {
    const canvas = document.createElement('canvas'); canvas.width = 64; canvas.height = 64;
    const ctx = canvas.getContext('2d'); ctx.font = '48px sans-serif';
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText(msg.avatar, 32, 36);
    avatar.src = canvas.toDataURL();
  }
  li.appendChild(avatar);
  const body = document.createElement('div'); body.className = 'msg-body';
  const header = document.createElement('div'); header.className = 'msg-header';
  header.innerHTML = msg.nickname;
  
  // æ·»åŠ ç­‰ç´šå¾½ç« 
  if (msg.level) {
    const levelBadge = document.createElement('span');
    levelBadge.className = 'level-badge';
    levelBadge.textContent = `Lv.${msg.level}`;
    header.appendChild(levelBadge);
  }
  
  // æ·»åŠ ç¨±è™Ÿå¾½ç« 
  if (msg.title) {
    const titleBadge = document.createElement('span');
    titleBadge.className = 'title-badge';
    titleBadge.textContent = msg.title;
    header.appendChild(titleBadge);
  }
  
  body.appendChild(header);
  
  // å¦‚æœæœ‰å¼•ç”¨çš„è¨Šæ¯ï¼Œå…ˆé¡¯ç¤ºå¼•ç”¨
  if (msg.replyTo) {
    const quotedDiv = document.createElement('div');
    quotedDiv.className = 'quoted-message';
    
    let quotedContent = msg.replyTo.content || '';
    // å¦‚æœæ²’æœ‰ contentï¼Œæ ¹æ“šé¡å‹é¡¯ç¤ºé è¨­æ–‡å­—
    if (!quotedContent) {
      if (msg.replyTo.type === 'image') {
        quotedContent = 'ğŸ–¼ï¸ åœ–ç‰‡';
      } else if (msg.replyTo.type === 'voice') {
        quotedContent = 'ğŸ¤ èªéŸ³è¨Šæ¯';
      } else {
        quotedContent = 'è¨Šæ¯';
      }
    }
    
    quotedDiv.innerHTML = `
      <div class="quoted-author">@${escapeHtml(msg.replyTo.nickname)}</div>
      <div class="quoted-content">${escapeHtml(quotedContent)}</div>
    `;
    body.appendChild(quotedDiv);
  }
  
  const content = document.createElement('div'); content.className = 'msg-content';
  switch (msg.type) {
    case 'chat':
      // ä½¿ç”¨ Markdown æ¸²æŸ“
      try {
        content.innerHTML = marked.parse(msg.content);
        // é«˜äº®ç¨‹å¼ç¢¼
        content.querySelectorAll('pre code').forEach((block) => {
          hljs.highlightElement(block);
        });
      } catch (e) {
        // å¦‚æœ Markdown è§£æå¤±æ•—ï¼Œé™ç´šç‚ºç´”æ–‡å­—
        content.textContent = msg.content;
      }
      break;
    case 'image':
      const img = document.createElement('img'); img.src = msg.content;
      img.style.maxWidth = '100%'; img.style.maxHeight = '300px'; img.style.borderRadius = '8px';
      img.onload = () => messagesEl.scrollTop = messagesEl.scrollHeight;
      content.appendChild(img);
      break;
    case 'voice': renderVoiceMessage(content, msg); break;
  }
  body.appendChild(content);
  
  // æ·»åŠ å›è¦†æŒ‰éˆ•
  const replyBtn = document.createElement('button');
  replyBtn.className = 'msg-reply-btn';
  replyBtn.textContent = 'â†©ï¸ å›è¦†';
  replyBtn.onclick = () => setReplyTo(msg);
  body.appendChild(replyBtn);
  const emojiPicker = document.createElement('div'); emojiPicker.className = 'msg-emoji-picker';
  const emojis = ['ğŸ‘', 'â¤ï¸', 'ğŸ˜‚', 'ğŸ˜®', 'ğŸ˜¢'];
  emojis.forEach(emoji => {
    const btn = document.createElement('button'); btn.textContent = emoji;
    btn.onclick = () => sendReaction(msg.timestamp, emoji);
    emojiPicker.appendChild(btn);
  });
  body.appendChild(emojiPicker);
  const reactionsEl = document.createElement('div'); reactionsEl.className = 'msg-reactions';
  body.appendChild(reactionsEl);
  li.appendChild(body);
  messagesEl.appendChild(li);
  messagesEl.scrollTop = messagesEl.scrollHeight;
  
  // è‡ªå‹•æœ—è®€è¨Šæ¯
  autoReadMessage(msg);
}
function renderVoiceMessage(content, msg) {
  const audio = new Audio(msg.content);
  const bar = document.createElement('div');
  bar.style.display = 'flex'; bar.style.alignItems = 'center';
  const playBtn = document.createElement('button'); playBtn.textContent = 'â–¶ï¸ æ’­æ”¾';
  const duration = document.createElement('span'); duration.textContent = ' 00:00';
  bar.appendChild(playBtn); bar.appendChild(duration);
  audio.onloadedmetadata = () => { duration.textContent = ` ${Math.floor(audio.duration)}s`; };
  playBtn.onclick = () => {
    if (audio.paused) { audio.play(); playBtn.textContent = 'â¸ï¸ æš«åœ'; }
    else { audio.pause(); playBtn.textContent = 'â–¶ï¸ æ’­æ”¾'; }
  };
  audio.onended = () => { playBtn.textContent = 'â–¶ï¸ æ’­æ”¾'; };
  const transcript = document.createElement('i');
  if (msg.transcript) {
    transcript.textContent = `"${msg.transcript}"`;
    transcript.style.display = 'block'; transcript.style.marginTop = '5px';
    transcript.style.opacity = '0.8';
  }
  content.appendChild(bar); 
  if (msg.transcript) content.appendChild(transcript);
}
function addSystemMessage(text) {
  const li = document.createElement('li'); li.className = 'message system';
  const body = document.createElement('div'); body.className = 'msg-body';
  const content = document.createElement('div'); content.className = 'msg-content';
  content.textContent = text;
  body.appendChild(content); li.appendChild(body);
  messagesEl.appendChild(li);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}
if ('MediaRecorder' in window && 'webkitSpeechRecognition' in window) {
  const recognition = new webkitSpeechRecognition();
  recognition.continuous = voiceContinuous;
  recognition.lang = voiceLang;
  recognition.interimResults = voiceInterim;
  let finalTranscript = '';
  let interimTranscript = '';
  
  recognition.onresult = event => {
    interimTranscript = '';
    finalTranscript = '';
    
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const transcript = event.results[i][0].transcript;
      if (event.results[i].isFinal) {
        finalTranscript += transcript;
      } else {
        interimTranscript += transcript;
      }
    }
    
    // é¡¯ç¤ºå³æ™‚è¾¨è­˜çµæœ
    if (voiceInterim) {
      document.getElementById('interim-result').textContent = interimTranscript;
    }
    
    // è™•ç†èªéŸ³å‘½ä»¤
    if (voiceCommands && finalTranscript) {
      handleVoiceCommand(finalTranscript);
    }
  };
  const startRec = () => {
    if (imageToSend) return;
    audioChunks = [];
    mediaRecorder.start(); recognition.start();
    recStatus.classList.add('rec'); voiceBtn.textContent = '... éŒ„éŸ³ä¸­ ...';
  };
  const stopRec = () => {
    mediaRecorder.stop(); recognition.stop();
    recStatus.classList.remove('rec'); voiceBtn.textContent = 'ğŸ¤ èªéŸ³ (æŒ‰ä½)';
  };
  recognition.onend = () => {
    document.getElementById('interim-result').textContent = '';
    if (audioChunks.length === 0) {
        finalTranscript = ''; return;
    }
    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
    const reader = new FileReader();
    reader.onload = () => {
        audioToSend = reader.result;
        audioTranscript = finalTranscript;
        messageInput.value = finalTranscript;
        messageInput.placeholder = 'èªéŸ³è¨Šæ¯å·²é™„åŠ  (å¯ç·¨è¼¯æ–‡å­—)';
        messageInput.focus();
        document.getElementById('audio-preview-container').style.display = 'flex';
        document.getElementById('image-label').style.display = 'none';
    };
    reader.readAsDataURL(audioBlob);
    audioChunks = [];
    finalTranscript = '';
    interimTranscript = '';
  };
  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(stream => {
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      voiceInput.onchange = () => { if (voiceInput.checked) startRec(); else stopRec(); };
      voiceBtn.onmousedown = voiceInput.onchange; voiceBtn.onmouseup = voiceInput.onchange;
      voiceBtn.ontouchstart = e => { e.preventDefault(); voiceInput.checked = true; voiceInput.onchange(); };
      voiceBtn.ontouchend = e => { e.preventDefault(); voiceInput.checked = false; voiceInput.onchange(); };
    });
} else {
  voiceBtn.textContent = 'ğŸš« ä¸æ”¯æ´èªéŸ³'; voiceBtn.disabled = true;
}

// âœ¨ (åŠŸèƒ½ 1) Modal JS
function showQuizModal() {
  modalBackdrop.style.display = 'block';
  quizModal.style.display = 'block';
  document.getElementById('quiz-question').focus();
}
function showVoteModal() {
  modalBackdrop.style.display = 'block';
  voteModal.style.display = 'block';
  document.getElementById('vote-question').focus();
}
function submitQuiz() {
  const question = document.getElementById('quiz-question').value;
  const answer = document.getElementById('quiz-answer').value;
  if (!question || !answer) {
    alert('é¡Œç›®å’Œç­”æ¡ˆéƒ½ä¸èƒ½ç‚ºç©ºï¼'); return;
  }
  ws.send(JSON.stringify({
    type: 'quiz_start', room: currentRoom, nickname: myNickname, avatar: myAvatar,
    question: question, answer: normalize(answer), timestamp: new Date().toISOString()
  }));
  closeModals();
  document.getElementById('quiz-question').value = '';
  document.getElementById('quiz-answer').value = '';
  onMessageSent('quiz_start');
}
function submitVote() {
  const question = document.getElementById('vote-question').value;
  const optionsStr = document.getElementById('vote-options').value;
  if (!question || !optionsStr) {
    alert('å•é¡Œå’Œé¸é …éƒ½ä¸èƒ½ç‚ºç©ºï¼'); return;
  }
  const options = optionsStr.split(',').map(s => s.trim()).filter(s => s);
  if (options.length < 2) {
    alert('è‡³å°‘éœ€è¦å…©å€‹é¸é …'); return;
  }
  ws.send(JSON.stringify({
    type: 'vote', room: currentRoom, nickname: myNickname, avatar: myAvatar,
    question: question, options: options, timestamp: new Date().toISOString()
  }));
  closeModals();
  document.getElementById('vote-question').value = '';
  onMessageSent('vote');
  document.getElementById('vote-options').value = '';
}
// (èˆŠçš„æŠ•ç¥¨/æ¶ç­”å‡½å¼ renderVote, sendVote... ç­‰èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
function renderVote(msg) {
  const li = document.createElement('li'); li.className = 'message system'; li.dataset.id = msg.timestamp;
  const body = document.createElement('div'); body.className = 'msg-body';
  const content = document.createElement('div'); content.className = 'msg-content msg-vote';
  content.innerHTML = `<strong>ğŸ“Š ${msg.nickname} ç™¼èµ·äº†æŠ•ç¥¨ï¼š</strong><br>${msg.question}`;
  const optionsEl = document.createElement('div'); optionsEl.style.marginTop = '10px';
  msg.options.forEach(opt => {
    const optBtn = document.createElement('a'); optBtn.className = 'vote-option';
    optBtn.textContent = opt; optBtn.href = '#';
    optBtn.onclick = e => {
      e.preventDefault(); sendVote(msg.timestamp, opt);
      optionsEl.querySelectorAll('a').forEach(a => { a.style.pointerEvents = 'none'; a.style.opacity = '0.6'; });
      optBtn.style.background = 'rgba(135, 206, 250, 0.4)';
    };
    optionsEl.appendChild(optBtn);
  });
  content.appendChild(optionsEl);
  const resultEl = document.createElement('div'); resultEl.className = 'vote-result';
  content.appendChild(resultEl);
  body.appendChild(content); li.appendChild(body);
  messagesEl.appendChild(li); messagesEl.scrollTop = messagesEl.scrollHeight;
}
function sendVote(voteId, option) {
  ws.send(JSON.stringify({ type: 'vote_answer', room: currentRoom, content: voteId, answer: option }));
}
function updateVoteResults(msg) {
  const voteEl = document.querySelector(`li[data-id="${msg.content}"] .msg-vote`);
  if (!voteEl) return;
  const resultEl = voteEl.querySelector('.vote-result');
  resultEl.innerHTML = '<strong>çµæœï¼š</strong><br>';
  for (const [option, count] of Object.entries(msg.results)) {
    resultEl.innerHTML += `${option}: ${count} ç¥¨<br>`;
  }
}
function renderQuiz(msg) {
  const li = document.createElement('li'); li.className = 'message system'; li.dataset.id = msg.timestamp;
  const body = document.createElement('div'); body.className = 'msg-body';
  const content = document.createElement('div'); content.className = 'msg-content msg-quiz';
  content.innerHTML = `<strong>ğŸ§  ${msg.nickname} ç™¼èµ·äº†æ¶ç­”ï¼š</strong><br>${msg.question}`;
  const inputEl = document.createElement('div'); inputEl.className = 'quiz-input';
  const answerInput = document.createElement('input'); answerInput.type = 'text';
  answerInput.placeholder = 'è¼¸å…¥ç­”æ¡ˆ...';
  const submitBtn = document.createElement('button'); submitBtn.textContent = 'æ¶ç­”ï¼';
  const sendAnswer = () => {
    const ans = answerInput.value;
    if (ans) { submitQuizAnswer(msg.timestamp, ans); answerInput.disabled = true; submitBtn.disabled = true; }
  };
  submitBtn.onclick = sendAnswer;
  answerInput.onkeydown = e => { if (e.key === 'Enter') sendAnswer(); };
  inputEl.appendChild(answerInput); inputEl.appendChild(submitBtn);
  content.appendChild(inputEl);
  body.appendChild(content); li.appendChild(body);
  messagesEl.appendChild(li); messagesEl.scrollTop = messagesEl.scrollHeight;
}
function submitQuizAnswer(quizId, answer) {
  ws.send(JSON.stringify({
    type: 'quiz_answer', room: currentRoom, nickname: myNickname, avatar: myAvatar,
    content: quizId, answer: normalize(answer) 
  }));
}
function updateQuizResult(msg) {
  addSystemMessage(`ğŸ† æ¶ç­”çµæŸï¼ ${msg.nickname} ç­”å°äº†ï¼ç­”æ¡ˆæ˜¯ï¼š${msg.answer}`);
  const quizEl = document.querySelector(`li[data-id="${msg.content}"] .msg-quiz`);
  if (quizEl) {
    quizEl.classList.add('answered');
    const inputEl = quizEl.querySelector('.quiz-input');
    if (inputEl) inputEl.style.display = 'none'; 
  }
}
function sendReaction(messageId, emoji) {
  ws.send(JSON.stringify({
    type: 'reaction', room: currentRoom, content: messageId, emoji: emoji
  }));
  updateAchievementProgress('reaction_send', 1);
  checkAchievements();
}
function normalize(s) {
  return (s || '').trim().toLowerCase()
    .replace(/[ï¼ã€‚ï¼Ÿï¼Œ]/g, m => ({'ï¼':'!','ã€‚':'.','ï¼Ÿ':'?','ï¼Œ':','}[m]));
}

// èªéŸ³å‘½ä»¤è™•ç†
function handleVoiceCommand(text) {
  const normalized = text.toLowerCase().trim();
  
  if (normalized.includes('ç™¼é€') || normalized.includes('é€å‡º') || normalized.includes('send')) {
    sendMsg();
  } else if (normalized.includes('æ¸…é™¤') || normalized.includes('clear')) {
    messageInput.value = '';
  } else if (normalized.includes('æ¶ç­”') || normalized.includes('quiz')) {
    showQuizModal();
  } else if (normalized.includes('æŠ•ç¥¨') || normalized.includes('vote')) {
    showVoteModal();
  } else if (normalized.includes('æœ—è®€') || normalized.includes('tts')) {
    toggleTTS();
  }
}

// é¡¯ç¤ºèªéŸ³è¨­å®š Modal
function showVoiceSettingsModal() {
  modalBackdrop.style.display = 'block';
  document.getElementById('voice-settings-modal').style.display = 'block';
  
  // è¼‰å…¥ç•¶å‰è¨­å®š
  document.getElementById('voice-lang').value = voiceLang;
  document.getElementById('voice-continuous').checked = voiceContinuous;
  document.getElementById('voice-interim').checked = voiceInterim;
  document.getElementById('voice-commands').checked = voiceCommands;
  document.getElementById('tts-rate').value = ttsRate;
  document.getElementById('tts-pitch').value = ttsPitch;
  document.getElementById('rate-value').textContent = ttsRate;
  document.getElementById('pitch-value').textContent = ttsPitch;
  
  // è¼‰å…¥å¯ç”¨çš„ TTS èªéŸ³
  loadTTSVoices();
}

// è¼‰å…¥å¯ç”¨çš„ TTS èªéŸ³
function loadTTSVoices() {
  availableVoices = speechSynthesis.getVoices();
  const select = document.getElementById('tts-voice');
  select.innerHTML = '';
  
  availableVoices.forEach((voice, index) => {
    const option = document.createElement('option');
    option.value = voice.name;
    option.textContent = `${voice.name} (${voice.lang})`;
    option.style.background = '#1a1a2e';
    option.style.color = '#fff';
    if (voice.name === ttsVoiceName || (index === 0 && !ttsVoiceName)) {
      option.selected = true;
    }
    select.appendChild(option);
  });
}

// å„²å­˜èªéŸ³è¨­å®š
function saveVoiceSettings() {
  voiceLang = document.getElementById('voice-lang').value;
  voiceContinuous = document.getElementById('voice-continuous').checked;
  voiceInterim = document.getElementById('voice-interim').checked;
  voiceCommands = document.getElementById('voice-commands').checked;
  ttsRate = parseFloat(document.getElementById('tts-rate').value);
  ttsPitch = parseFloat(document.getElementById('tts-pitch').value);
  ttsVoiceName = document.getElementById('tts-voice').value;
  
  // å„²å­˜åˆ° localStorage
  localStorage.setItem('voiceLang', voiceLang);
  localStorage.setItem('voiceContinuous', voiceContinuous);
  localStorage.setItem('voiceInterim', voiceInterim);
  localStorage.setItem('voiceCommands', voiceCommands);
  localStorage.setItem('ttsRate', ttsRate);
  localStorage.setItem('ttsPitch', ttsPitch);
  localStorage.setItem('ttsVoiceName', ttsVoiceName);
  
  // æ›´æ–°èªéŸ³è¾¨è­˜è¨­å®š
  if (typeof recognition !== 'undefined') {
    recognition.lang = voiceLang;
    recognition.continuous = voiceContinuous;
    recognition.interimResults = voiceInterim;
  }
  
  closeModals();
  addSystemMessage('âœ… èªéŸ³è¨­å®šå·²å„²å­˜');
}

// æ¸¬è©¦ TTS
function testTTS() {
  const text = 'é€™æ˜¯èªéŸ³æœ—è®€æ¸¬è©¦ã€‚';
  speakText(text);
}

// åˆ‡æ› TTS
function toggleTTS() {
  ttsEnabled = !ttsEnabled;
  localStorage.setItem('ttsEnabled', ttsEnabled);
  const btn = document.getElementById('tts-toggle');
  btn.textContent = ttsEnabled ? 'ğŸ”Š æœ—è®€ (é–‹)' : 'ğŸ”‡ æœ—è®€ (é—œ)';
  btn.style.background = ttsEnabled ? 'rgba(0, 255, 127, 0.3)' : 'rgba(255,255,255,0.1)';
  addSystemMessage(ttsEnabled ? 'âœ… è¨Šæ¯æœ—è®€å·²é–‹å•Ÿ' : 'ğŸ”‡ è¨Šæ¯æœ—è®€å·²é—œé–‰');
}

// æœ—è®€æ–‡å­—
function speakText(text) {
  if (!speechSynthesis) return;
  
  // åœæ­¢ç•¶å‰æœ—è®€
  speechSynthesis.cancel();
  
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.rate = ttsRate;
  utterance.pitch = ttsPitch;
  
  // é¸æ“‡èªéŸ³
  if (ttsVoiceName) {
    const voice = availableVoices.find(v => v.name === ttsVoiceName);
    if (voice) utterance.voice = voice;
  }
  
  speechSynthesis.speak(utterance);
}

// åœ¨æ¥æ”¶è¨Šæ¯æ™‚è‡ªå‹•æœ—è®€
function autoReadMessage(msg) {
  if (!ttsEnabled || msg.type === 'system') return;
  
  let textToRead = '';
  if (msg.type === 'chat') {
    textToRead = `${msg.nickname}èªªï¼š${msg.content}`;
  } else if (msg.type === 'voice' && msg.transcript) {
    textToRead = `${msg.nickname}çš„èªéŸ³ï¼š${msg.transcript}`;
  }
  
  if (textToRead) {
    speakText(textToRead);
  }
}

// è¨­å®šå¼•ç”¨è¨Šæ¯
function setReplyTo(msg) {
  let displayContent = msg.content;
  
  // æ ¹æ“šè¨Šæ¯é¡å‹æ±ºå®šé¡¯ç¤ºå…§å®¹
  if (msg.type === 'image') {
    displayContent = 'ğŸ–¼ï¸ åœ–ç‰‡';
  } else if (msg.type === 'voice') {
    // å¦‚æœèªéŸ³è¨Šæ¯æœ‰è½‰æ–‡å­—å…§å®¹ï¼Œé¡¯ç¤ºå®ƒï¼›å¦å‰‡é¡¯ç¤º "èªéŸ³è¨Šæ¯"
    displayContent = msg.transcript ? `ğŸ¤ "${msg.transcript}"` : 'ğŸ¤ èªéŸ³è¨Šæ¯';
  }
  
  replyToMessage = {
    timestamp: msg.timestamp,
    nickname: msg.nickname,
    content: displayContent,
    type: msg.type
  };
  
  const replyPreview = document.getElementById('reply-preview');
  replyPreview.style.display = 'block';
  replyPreview.querySelector('.reply-author').textContent = `å›è¦† @${msg.nickname}`;
  replyPreview.querySelector('.reply-content').textContent = displayContent;
  messageInput.focus();
}

// å–æ¶ˆå¼•ç”¨
function cancelReply() {
  replyToMessage = null;
  document.getElementById('reply-preview').style.display = 'none';
}

// é¡¯ç¤º Markdown å¹«åŠ©
function showMarkdownHelp() {
  modalBackdrop.style.display = 'block';
  document.getElementById('markdown-help-modal').style.display = 'block';
}

// HTML è½‰ç¾©å‡½æ•¸ï¼ˆé˜²æ­¢ XSSï¼‰
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// === ç­‰ç´šç³»çµ±åŠŸèƒ½ ===

// ç²å–ç•¶å‰ç­‰ç´šæ‰€éœ€ç¶“é©—
function getExpForLevel(level) {
  if (level <= 0 || level > expTable.length) return expTable[expTable.length - 1];
  return expTable[level - 1];
}

// æ·»åŠ ç¶“é©—å€¼
function addExp(amount) {
  userExp += amount;
  const requiredExp = getExpForLevel(userLevel);
  
  // æª¢æŸ¥æ˜¯å¦å‡ç´š
  if (userExp >= requiredExp) {
    userExp -= requiredExp;
    userLevel++;
    localStorage.setItem('userLevel', userLevel);
    showLevelUpAnimation();
    checkAchievements();
    checkTitles();
  }
  
  localStorage.setItem('userExp', userExp);
  updateUserLevelUI();
}

// é¡¯ç¤ºå‡ç´šå‹•ç•«
function showLevelUpAnimation() {
  const animation = document.createElement('div');
  animation.className = 'level-up-animation';
  animation.innerHTML = `ğŸ‰ å‡ç´šäº†ï¼<br>Lv.${userLevel}`;
  document.body.appendChild(animation);
  
  setTimeout(() => {
    animation.remove();
  }, 2000);
  
  // æ’­æ”¾éŸ³æ•ˆï¼ˆå¦‚æœæœ‰ï¼‰
  addSystemMessage(`ğŸŠ æ­å–œï¼ä½ å‡åˆ°äº† Lv.${userLevel}ï¼`);
}

// æ›´æ–°ç”¨æˆ¶ç­‰ç´š UI
function updateUserLevelUI() {
  const requiredExp = getExpForLevel(userLevel);
  const expPercent = (userExp / requiredExp * 100).toFixed(1);
  
  // æ›´æ–°å´é‚Šæ¬„
  document.getElementById('user-level-badge').textContent = `Lv.${userLevel}`;
  document.getElementById('user-exp-bar').style.width = `${expPercent}%`;
  document.getElementById('user-exp-text').textContent = `${userExp}/${requiredExp} EXP`;
  
  if (userTitle) {
    document.getElementById('user-title-badge').textContent = userTitle;
    document.getElementById('user-title-badge').style.display = 'inline-block';
  }
}

// æª¢æŸ¥ä¸¦è§£é–æˆå°±
function checkAchievements() {
  achievements.forEach(ach => {
    if (ach.id.startsWith('chat_')) {
      ach.progress = totalMessages;
    } else if (ach.id.startsWith('level_')) {
      ach.progress = userLevel;
    }
    
    // æª¢æŸ¥æ˜¯å¦å®Œæˆ
    if (ach.progress >= ach.target && !unlockedBadges.includes(ach.id)) {
      unlockAchievement(ach);
    }
    
    // ä¿å­˜é€²åº¦
    localStorage.setItem(`ach_${ach.id}`, ach.progress);
  });
}

// è§£é–æˆå°±
function unlockAchievement(achievement) {
  unlockedBadges.push(achievement.id);
  localStorage.setItem('unlockedBadges', JSON.stringify(unlockedBadges));
  
  // é¡¯ç¤ºè§£é–é€šçŸ¥
  addSystemMessage(`ğŸ† è§£é–æˆå°±ï¼š${achievement.icon} ${achievement.name}ï¼`);
  
  // çå‹µç¶“é©—å€¼
  addExp(50);
}

// æª¢æŸ¥ç¨±è™Ÿ
function checkTitles() {
  for (const [key, title] of Object.entries(titles)) {
    if (title.condition() && userTitle !== title.name) {
      userTitle = title.name;
      localStorage.setItem('userTitle', userTitle);
      addSystemMessage(`ğŸ–ï¸ ç²å¾—æ–°ç¨±è™Ÿï¼š${title.name}ï¼`);
      updateUserLevelUI();
      break;
    }
  }
}

// é¡¯ç¤ºå€‹äººè³‡æ–™
function showProfileModal() {
  modalBackdrop.style.display = 'block';
  document.getElementById('profile-modal').style.display = 'block';
  
  // æ›´æ–°å€‹äººè³‡æ–™
  const profileAvatar = document.getElementById('profile-avatar');
  if (myAvatar.startsWith('http') || myAvatar.startsWith('data:')) {
    profileAvatar.src = myAvatar;
  } else {
    const canvas = document.createElement('canvas');
    canvas.width = 80; canvas.height = 80;
    const ctx = canvas.getContext('2d');
    ctx.font = '60px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(myAvatar, 40, 46);
    profileAvatar.src = canvas.toDataURL();
  }
  
  document.getElementById('profile-nickname').textContent = myNickname;
  document.getElementById('profile-level-badge').textContent = `Lv.${userLevel}`;
  document.getElementById('profile-title').textContent = userTitle || 'ç„¡ç¨±è™Ÿ';
  document.getElementById('profile-title').style.display = userTitle ? 'inline-block' : 'none';
  
  const requiredExp = getExpForLevel(userLevel);
  const expPercent = (userExp / requiredExp * 100).toFixed(1);
  document.getElementById('profile-exp-bar').style.width = `${expPercent}%`;
  document.getElementById('profile-exp-text').textContent = `${userExp}/${requiredExp} EXP`;
  
  // çµ±è¨ˆè³‡æ–™
  document.getElementById('stat-level').textContent = userLevel;
  document.getElementById('stat-messages').textContent = totalMessages;
  document.getElementById('stat-badges').textContent = unlockedBadges.length;
  
  // æ¸²æŸ“æˆå°±åˆ—è¡¨
  renderAchievements();
  
  // æ¸²æŸ“å¾½ç« 
  renderBadges();
}

// æ¸²æŸ“æˆå°±åˆ—è¡¨
function renderAchievements() {
  const list = document.getElementById('achievement-list');
  list.innerHTML = '';
  
  achievements.forEach(ach => {
    const unlocked = ach.progress >= ach.target;
    const progress = Math.min(100, (ach.progress / ach.target * 100)).toFixed(0);
    
    const item = document.createElement('div');
    item.className = `achievement-item ${unlocked ? 'unlocked' : ''}`;
    item.innerHTML = `
      <div class="achievement-icon">${ach.icon}</div>
      <div class="achievement-info">
        <div class="achievement-name">${ach.name}</div>
        <div class="achievement-desc">${ach.desc}</div>
        <div class="achievement-progress">
          <div class="achievement-progress-fill" style="width: ${progress}%;"></div>
        </div>
        <div style="font-size: 0.75em; opacity: 0.7; margin-top: 4px;">
          ${ach.progress}/${ach.target} ${unlocked ? 'âœ“ å·²å®Œæˆ' : ''}
        </div>
      </div>
    `;
    list.appendChild(item);
  });
}

// æ¸²æŸ“å¾½ç« 
function renderBadges() {
  const grid = document.getElementById('badges-grid');
  grid.innerHTML = '';
  
  achievements.forEach(ach => {
    const unlocked = unlockedBadges.includes(ach.id);
    const item = document.createElement('div');
    item.className = `badge-item ${unlocked ? '' : 'locked'}`;
    item.innerHTML = `
      <div class="badge-icon">${ach.icon}</div>
      <div class="badge-name">${ach.name}</div>
    `;
    if (unlocked) {
      item.title = ach.desc;
    }
    grid.appendChild(item);
  });
}

// è¨Šæ¯ç™¼é€æ™‚å¢åŠ ç¶“é©—å’Œçµ±è¨ˆ
function onMessageSent(type) {
  totalMessages++;
  localStorage.setItem('totalMessages', totalMessages);
  
  // æ ¹æ“šè¨Šæ¯é¡å‹çµ¦äºˆä¸åŒç¶“é©—
  let expGain = 10;
  if (type === 'image') expGain = 15;
  if (type === 'voice') expGain = 20;
  if (type === 'vote' || type === 'quiz_start') expGain = 25;
  
  addExp(expGain);
  
  // æ›´æ–°æˆå°±é€²åº¦
  updateAchievementProgress('first_msg', 1);
  updateAchievementProgress('chat_10', 1);
  updateAchievementProgress('chat_50', 1);
  updateAchievementProgress('chat_100', 1);
  
  if (type === 'image') updateAchievementProgress('image_send', 1);
  if (type === 'voice') updateAchievementProgress('voice_use', 1);
  if (type === 'vote') updateAchievementProgress('vote_create', 1);
  if (type === 'quiz_start') updateAchievementProgress('quiz_create', 1);
  
  checkAchievements();
  checkTitles();
}

// æ›´æ–°æˆå°±é€²åº¦
function updateAchievementProgress(achId, increment = 1) {
  const ach = achievements.find(a => a.id === achId);
  if (ach && ach.progress < ach.target) {
    ach.progress = Math.min(ach.progress + increment, ach.target);
    localStorage.setItem(`ach_${achId}`, ach.progress);
  }
}

function checkExistingLogin() {
  const storedUser = localStorage.getItem("chatUser");
  const storedAvatar = localStorage.getItem("chatAvatar");
  if (storedUser && storedAvatar) {
    myNickname = storedUser;
    myAvatar = storedAvatar;
    loginWindow.style.display = 'none';
    chatWindow.style.display = 'block';
    
    // åˆå§‹åŒ–ç”¨æˆ¶ç­‰ç´š UI
    updateUserLevelUI();
    const userAvatarSidebar = document.getElementById('user-avatar-sidebar');
    if (myAvatar.startsWith('http') || myAvatar.startsWith('data:')) {
      userAvatarSidebar.src = myAvatar;
    } else {
      const canvas = document.createElement('canvas');
      canvas.width = 40; canvas.height = 40;
      const ctx = canvas.getContext('2d');
      ctx.font = '30px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(myAvatar, 20, 23);
      userAvatarSidebar.src = canvas.toDataURL();
    }
    document.getElementById('user-nickname-sidebar').textContent = myNickname;
    
    initWS();
  }
}

// åˆå§‹åŒ– TTS
if (speechSynthesis) {
  speechSynthesis.onvoiceschanged = loadTTSVoices;
  loadTTSVoices();
  
  // è¨­å®š TTS æŒ‰éˆ•ç‹€æ…‹
  const ttsBtn = document.getElementById('tts-toggle');
  if (ttsBtn) {
    ttsBtn.textContent = ttsEnabled ? 'ğŸ”Š æœ—è®€ (é–‹)' : 'ğŸ”‡ æœ—è®€ (é—œ)';
    ttsBtn.style.background = ttsEnabled ? 'rgba(0, 255, 127, 0.3)' : 'rgba(255,255,255,0.1)';
  }
}

// è¨­å®šæ»‘æ¡¿å³æ™‚æ›´æ–°
document.addEventListener('DOMContentLoaded', () => {
  const rateSlider = document.getElementById('tts-rate');
  const pitchSlider = document.getElementById('tts-pitch');
  
  if (rateSlider) {
    rateSlider.oninput = function() {
      document.getElementById('rate-value').textContent = this.value;
    };
  }
  
  if (pitchSlider) {
    pitchSlider.oninput = function() {
      document.getElementById('pitch-value').textContent = this.value;
    };
  }
});

window.onload = checkExistingLogin;

</script>
</body>
</html>