<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>çŒœæ•¸å­—ç«¶æŠ€ç‰ˆ V2</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;700&display=swap" rel="stylesheet">
<style>
/* âœ¨ å…¨å±€æ¨£å¼ */
html, body { 
  margin: 0; padding: 0; height: 100%; font-family: 'Nunito', 'Segoe UI', sans-serif; 
  color: #e0f7fa; display: flex; justify-content: center; align-items: center;
  background-color: #0a0a1a;
  overflow: hidden;
  cursor: url("my_cursor.cur"), auto; /* è‡ªè¨‚é¼ æ¨™ */
}
canvas#galaxy { position: fixed; top: 0; left: 0; z-index: -1; }
canvas#confetti { position: fixed; top: 0; left: 0; z-index: 999; pointer-events: none; }

.container { 
  background: rgba(16, 18, 27, 0.75); 
  backdrop-filter: blur(16px); 
  border-radius: 20px; 
  padding: 40px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255, 255, 255, 0.1);
  width: 90%; 
  max-width: 900px; 
  color: #fff; 
  z-index: 1;
  text-align: center;
  transition: transform 0.3s ease;
}

.game-layout {
  display: flex;
  flex-wrap: wrap;
  gap: 40px;
}
.game-panel {
  flex: 1.2;
  min-width: 320px;
  text-align: left;
  display: flex;
  flex-direction: column;
  justify-content: center;
}
.info-panel {
  flex: 0.8;
  min-width: 280px;
  text-align: left;
  background: rgba(0,0,0,0.2);
  border-radius: 16px;
  padding: 20px;
  border: 1px solid rgba(255,255,255,0.05);
}

h2 { 
  font-size: 2.8em; 
  font-weight: 700; 
  margin: 0 0 10px 0;
  background: linear-gradient(45deg, #87CEFA, #00BFFF);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 0 20px rgba(135, 206, 250, 0.3);
}

.status-bar {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
  font-size: 1.1em;
  opacity: 0.9;
}
.status-item {
  background: rgba(255,255,255,0.1);
  padding: 5px 12px;
  border-radius: 20px;
  display: flex;
  align-items: center;
  gap: 5px;
}

/* éŠæˆ²æ§åˆ¶å€ */
.control-group {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}
select {
  background: rgba(0, 0, 0, 0.3);
  color: #fff;
  border: 1px solid rgba(255,255,255,0.2);
  padding: 10px;
  border-radius: 8px;
  font-size: 1em;
  cursor: pointer;
  outline: none;
}
.sound-btn {
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid rgba(255,255,255,0.2);
  width: 44px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2em;
}

.game-box {
  margin: 20px 0;
  display: flex;
  gap: 10px;
  position: relative;
}
input[type="number"] {
  font-family: 'Nunito', 'Segoe UI', sans-serif;
  font-size: 1.8em;
  padding: 15px 20px; 
  border-radius: 12px;
  border: 2px solid rgba(135, 206, 250, 0.3);
  background: rgba(0, 0, 0, 0.2);
  color: #fff;
  flex-grow: 1;
  text-align: center;
  transition: all 0.3s;
  cursor: url("my_text.cur"), text;
}
input[type="number"]:focus {
  border-color: #87CEFA;
  box-shadow: 0 0 15px rgba(135, 206, 250, 0.3);
  outline: none;
}
input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; }

button.action-btn {
  font-size: 1.3em;
  padding: 0 30px;
  border-radius: 12px;
  border: none;
  background: linear-gradient(135deg, #87CEFA, #00BFFF);
  color: #000;
  font-weight: 800;
  cursor: url("my_pointer.cur"), pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 15px rgba(0, 191, 255, 0.3);
}
button.action-btn:hover { 
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(0, 191, 255, 0.5);
}
button.action-btn:active { transform: translateY(1px); }

/* åé¥‹å‹•ç•« */
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-10px); }
  75% { transform: translateX(10px); }
}
.shake { animation: shake 0.4s ease-in-out; }

#feedback {
  font-size: 1.5em;
  font-weight: bold;
  margin: 10px 0;
  min-height: 1.5em;
  opacity: 0;
  transform: translateY(10px);
  transition: all 0.3s ease;
}
#feedback.show { opacity: 1; transform: translateY(0); }
#feedback.low { color: #87CEFA; text-shadow: 0 0 10px rgba(135, 206, 250, 0.5); }
#feedback.high { color: #FF6B6B; text-shadow: 0 0 10px rgba(255, 107, 107, 0.5); }
#feedback.win { color: #4CAF50; text-shadow: 0 0 10px rgba(76, 175, 80, 0.5); font-size: 1.8em; }

/* æç¤ºæ¢ */
.hint-bar-container {
  width: 100%;
  height: 6px;
  background: rgba(255,255,255,0.1);
  border-radius: 3px;
  margin-top: 10px;
  overflow: hidden;
  position: relative;
}
.hint-bar {
  height: 100%;
  background: linear-gradient(90deg, #87CEFA, #FF6B6B);
  width: 100%;
  opacity: 0.5;
}
.hint-marker {
  position: absolute;
  top: 0;
  width: 4px;
  height: 100%;
  background: #fff;
  box-shadow: 0 0 5px #fff;
  transition: left 0.3s;
  display: none;
}

.nav-btns {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}
.nav-btn {
  flex: 1;
  padding: 12px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.1);
  color: #ccc;
  border-radius: 8px;
  cursor: url("my_pointer.cur"), pointer;
  transition: all 0.2s;
}
.nav-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }

/* æ­·å²è¨˜éŒ„èˆ‡æ’è¡Œæ¦œ */
h3 { border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; margin-top: 0; color: #aaa; font-size: 1em; text-transform: uppercase; letter-spacing: 1px; }

#guess-history {
  list-style: none;
  padding: 0;
  margin: 0 0 20px 0;
  height: 180px;
  overflow-y: auto;
}
#guess-history li {
  padding: 8px 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  display: flex;
  justify-content: space-between;
  font-size: 1.1em;
}
#guess-history li .val { font-weight: bold; }
#guess-history li.low .val { color: #87CEFA; }
#guess-history li.high .val { color: #FF6B6B; }
#guess-history li .tag { font-size: 0.8em; opacity: 0.6; }

table { width: 100%; border-collapse: collapse; }
th { text-align: left; font-size: 0.8em; color: #aaa; padding: 5px; }
td { padding: 8px 5px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9em; }
.rank-1 { color: #FFD700; font-weight: bold; }
.rank-2 { color: #C0C0C0; font-weight: bold; }
.rank-3 { color: #CD7F32; font-weight: bold; }
.avatar-img { width: 24px; height: 24px; border-radius: 50%; vertical-align: middle; margin-right: 8px; }

/* æ»¾å‹•æ¢ */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
::-webkit-scrollbar-thumb { background: rgba(135, 206, 250, 0.3); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(135, 206, 250, 0.5); }

/* é¼ æ¨™æ¨£å¼ */
button, select, .nav-btn, .sound-btn { cursor: url("my_pointer.cur"), pointer !important; }
</style>
</head>
<body>

<canvas id="galaxy"></canvas>
<canvas id="confetti"></canvas>

<div class="container">
  <div class="game-layout">
    
    <!-- å·¦å´ï¼šéŠæˆ²ä¸»å€ -->
    <div class="game-panel">
      <h2>ğŸ”¢ çµ‚æ¥µçŒœæ•¸å­—</h2>
      
      <div class="control-group">
        <select id="difficulty" onchange="changeDifficulty()">
          <option value="50">ğŸŸ¢ ç°¡å–® (1-50)</option>
          <option value="100" selected>ğŸŸ¡ æ™®é€š (1-100)</option>
          <option value="1000">ğŸ”´ å›°é›£ (1-1000)</option>
          <option value="10000">ğŸ’€ æƒ¡å¤¢ (1-10000)</option>
        </select>
        <button class="sound-btn" id="sound-toggle" onclick="toggleSound()" title="é–‹é—œéŸ³æ•ˆ">ğŸ”Š</button>
      </div>

      <div class="status-bar">
        <div class="status-item">â±ï¸ <span id="timer">0</span>s</div>
        <div class="status-item">ğŸ¯ <span id="attempts-text">0 æ¬¡</span></div>
        <div class="status-item">ğŸ“ ç¯„åœ: <span id="range-text">1-100</span></div>
      </div>

      <div id="feedback">æº–å‚™é–‹å§‹...</div>
      
      <div class="game-box" id="game-box">
        <input id="guess" type="number" placeholder="è¼¸å…¥æ•¸å­—" onkeydown="if(event.key==='Enter') checkGuess();">
        <button class="action-btn" id="guess-btn" onclick="checkGuess()">çŒœï¼</button>
      </div>

      <!-- è¦–è¦ºåŒ–æç¤ºæ¢ -->
      <div class="hint-bar-container">
        <div class="hint-bar"></div>
        <div class="hint-marker" id="hint-marker"></div>
      </div>

      <div class="nav-btns">
        <button onclick="resetGame()" class="nav-btn">ğŸ”„ é‡æ–°é–‹å§‹</button>
        <button onclick="location.href='index.html'" class="nav-btn">ğŸšª è¿”å›å¤§å»³</button>
      </div>
    </div>

    <!-- å³å´ï¼šè³‡è¨Šå€ -->
    <div class="info-panel">
      <h3>ğŸ“œ æœ¬å±€ç´€éŒ„</h3>
      <ul id="guess-history">
        <!-- æ­·å²è¨˜éŒ„ -->
      </ul>
      
      <h3>ğŸ† å…¨åŸŸæ’è¡Œæ¦œ</h3>
      <div style="height: 200px; overflow-y: auto;">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>ç©å®¶</th>
              <th>æ¬¡æ•¸</th>
              <th>æ™‚é–“</th>
            </tr>
          </thead>
          <tbody id="leaderboard-body">
            <!-- æ’è¡Œæ¦œæ•¸æ“š -->
          </tbody>
        </table>
      </div>
    </div>
  </div> 
</div>

<script>
// --- ğŸŒŒ æ˜Ÿç©ºèƒŒæ™¯ ---
const canvas = document.getElementById('galaxy');
const ctx = canvas.getContext('2d');
let stars = [];
function initStars() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  stars = [];
  for (let i = 0; i < 800; i++) {
    stars.push({ x: Math.random(), y: Math.random(), z: Math.random() });
  }
}
function drawGalaxy() {
  ctx.fillStyle = '#0a0a1a';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.save();
  ctx.translate(canvas.width / 2, canvas.height / 2);
  let time = Date.now() * 0.0001;
  stars.forEach(star => {
    let x = (star.x - 0.5) * canvas.width * (2 - star.z) + Math.sin(time + star.z) * 100 * star.z;
    let y = (star.y - 0.5) * canvas.height * (2 - star.z) + Math.cos(time + star.x) * 100 * star.z;
    let r = (1 - star.z) * 1.5;
    let a = (1 - star.z);
    ctx.fillStyle = `rgba(255, 255, 255, ${a})`;
    ctx.beginPath(); ctx.arc(x, y, r, 0, 2 * Math.PI); ctx.fill();
  });
  ctx.restore();
  requestAnimationFrame(drawGalaxy);
}
initStars();
drawGalaxy();
window.onresize = initStars;

// --- ğŸ”Š éŸ³æ•ˆç³»çµ± (Web Audio API) ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let soundEnabled = true;

function playTone(freq, type, duration) {
  if (!soundEnabled) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = type;
  osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
  gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + duration);
}

function playSound(type) {
  if (audioCtx.state === 'suspended') audioCtx.resume();
  switch (type) {
    case 'correct':
      playTone(600, 'sine', 0.1);
      setTimeout(() => playTone(800, 'sine', 0.2), 100);
      break;
    case 'wrong':
      playTone(200, 'sawtooth', 0.3);
      break;
    case 'win':
      [400, 500, 600, 800].forEach((f, i) => setTimeout(() => playTone(f, 'square', 0.2), i * 150));
      break;
  }
}

function toggleSound() {
  soundEnabled = !soundEnabled;
  document.getElementById('sound-toggle').textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
}

// --- ğŸ‰ å½©å¸¶ç‰¹æ•ˆ ---
const confettiCanvas = document.getElementById('confetti');
const cCtx = confettiCanvas.getContext('2d');
let confetti = [];

function fireConfetti() {
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;
  confetti = [];
  for (let i = 0; i < 150; i++) {
    confetti.push({
      x: window.innerWidth / 2, y: window.innerHeight / 2,
      vx: (Math.random() - 0.5) * 20, vy: (Math.random() - 0.5) * 20 - 5,
      color: `hsl(${Math.random() * 360}, 100%, 50%)`,
      size: Math.random() * 10 + 5
    });
  }
  animateConfetti();
}

function animateConfetti() {
  cCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
  let active = false;
  confetti.forEach(p => {
    p.x += p.vx; p.y += p.vy; p.vy += 0.5; // gravity
    cCtx.fillStyle = p.color;
    cCtx.fillRect(p.x, p.y, p.size, p.size);
    if (p.y < window.innerHeight) active = true;
  });
  if (active) requestAnimationFrame(animateConfetti);
}

// --- ğŸ® éŠæˆ²é‚è¼¯ ---
let ws;
let myNickname = '', myAvatar = '';
let maxRange = 100;
let answer = 0;
let attempts = 0;
let startTime = 0;
let finished = false;
let timerInterval;

const guessInput = document.getElementById("guess");
const feedbackEl = document.getElementById("feedback");
const historyList = document.getElementById("guess-history");
const hintMarker = document.getElementById("hint-marker");

window.onload = () => {
  myNickname = localStorage.getItem("chatUser");
  myAvatar = localStorage.getItem("chatAvatar");
  if (!myNickname) {
    alert("è«‹å…ˆç™»å…¥èŠå¤©å®¤ï¼");
    location.href = 'index.html';
    return;
  }
  initWS();
  resetGame();
};

function initWS() {
  const proto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${window.location.host}/ws`);
  ws.onopen = () => {
    ws.send(JSON.stringify({ type: 'switch', room: '_game_', nickname: myNickname, avatar: myAvatar }));
    ws.send(JSON.stringify({ type: 'get_leaderboard' }));
  };
  ws.onmessage = event => {
    const msg = JSON.parse(event.data);
    if (msg.type === 'leaderboard_update') {
      renderLeaderboard(JSON.parse(msg.content));
    }
  };
}

function changeDifficulty() {
  maxRange = parseInt(document.getElementById('difficulty').value);
  document.getElementById('range-text').textContent = `1-${maxRange}`;
  resetGame();
}

function resetGame() {
  answer = Math.floor(Math.random() * maxRange) + 1;
  attempts = 0;
  startTime = Date.now();
  finished = false;
  
  guessInput.value = "";
  guessInput.disabled = false;
  document.getElementById('guess-btn').disabled = false;
  feedbackEl.textContent = "æº–å‚™é–‹å§‹...";
  feedbackEl.className = "";
  historyList.innerHTML = "";
  document.getElementById("attempts-text").textContent = "0 æ¬¡";
  document.getElementById("timer").textContent = "0";
  hintMarker.style.display = 'none';
  
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    if (!finished) document.getElementById("timer").textContent = Math.floor((Date.now() - startTime) / 1000);
  }, 1000);
}

function checkGuess() {
  if (finished) return;
  const guess = parseInt(guessInput.value);
  
  if (isNaN(guess) || guess < 1 || guess > maxRange) {
    feedbackEl.textContent = `è«‹è¼¸å…¥ 1-${maxRange} ä¹‹é–“çš„æ•¸å­—`;
    feedbackEl.className = 'show';
    return;
  }

  attempts++;
  document.getElementById("attempts-text").textContent = `${attempts} æ¬¡`;
  
  // æ›´æ–°æç¤ºæ¢ä½ç½®
  const percent = (guess / maxRange) * 100;
  hintMarker.style.left = `${percent}%`;
  hintMarker.style.display = 'block';

  const li = document.createElement("li");
  
  if (guess === answer) {
    // Win
    finished = true;
    clearInterval(timerInterval);
    const timeUsed = Math.floor((Date.now() - startTime) / 1000);
    
    feedbackEl.textContent = `ğŸ‰ æ­å–œï¼ç­”æ¡ˆæ˜¯ ${answer}ï¼`;
    feedbackEl.className = 'show win';
    playSound('win');
    fireConfetti();
    
    li.innerHTML = `<span class="val" style="color:#4CAF50">${guess}</span> <span class="tag">âœ… æ­£ç¢ºç­”æ¡ˆ</span>`;
    guessInput.disabled = true;
    document.getElementById('guess-btn').disabled = true;
    
    // Send score
    ws.send(JSON.stringify({ type: 'game_score', tries: attempts, time: timeUsed }));
    
  } else {
    // Wrong
    playSound('wrong');
    document.querySelector('.container').classList.add('shake');
    setTimeout(() => document.querySelector('.container').classList.remove('shake'), 400);
    
    if (guess < answer) {
      feedbackEl.textContent = "å¤ªä½äº†ï¼å†è©¦è©¦çœ‹ ğŸ”¼";
      feedbackEl.className = 'show low';
      li.className = 'low';
      li.innerHTML = `<span class="val">${guess}</span> <span class="tag">å¤ªä½</span>`;
    } else {
      feedbackEl.textContent = "å¤ªé«˜äº†ï¼å†è©¦è©¦çœ‹ ğŸ”½";
      feedbackEl.className = 'show high';
      li.className = 'high';
      li.innerHTML = `<span class="val">${guess}</span> <span class="tag">å¤ªé«˜</span>`;
    }
  }
  
  historyList.prepend(li); // æœ€æ–°ç´€éŒ„åœ¨æœ€ä¸Šé¢
  guessInput.value = "";
  guessInput.focus();
}

function renderLeaderboard(scores) {
  const board = document.getElementById("leaderboard-body");
  board.innerHTML = "";
  if (!scores || scores.length === 0) {
    board.innerHTML = '<tr><td colspan="4" style="text-align:center; opacity:0.5;">æš«ç„¡ç´€éŒ„</td></tr>';
    return;
  }
  scores.forEach((score, index) => {
    const row = board.insertRow();
    let rankClass = '';
    if (index === 0) rankClass = 'rank-1';
    if (index === 1) rankClass = 'rank-2';
    if (index === 2) rankClass = 'rank-3';
    
    let avatarHtml = score.avatar.startsWith('data:') || score.avatar.startsWith('avatars/') 
      ? `<img src="${score.avatar}" class="avatar-img">` 
      : `<span style="margin-right:5px;">${score.avatar}</span>`;

    row.innerHTML = `
      <td class="${rankClass}">#${index + 1}</td>
      <td>${avatarHtml} ${score.nickname}</td>
      <td>${score.tries}</td>
      <td>${score.time}s</td>
    `;
  });
}
</script>
</body>
</html>
